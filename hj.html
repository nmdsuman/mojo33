<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for consistency and style */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hiding the number input spinners for a cleaner UI */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Modal styling */
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 640px) {
            .table-cell-padding {
                padding-left: 0.2rem;
                padding-right: 0.2rem;
            }
            .responsive-input {
                width: 2.5rem; /* tighter inputs on mobile to avoid horizontal overflow */
            }
            /* Prevent horizontal scroll on mobile */
            .no-x-overflow {
                overflow-x: hidden;
            }
            /* Make table fit within viewport width */
            table {
                table-layout: fixed;
                width: 100%;
            }
            thead th, tbody td {
                word-break: break-word;
                font-size: 0.85rem; /* slightly smaller text on mobile */
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-0 sm:p-4 sm:flex sm:items-center sm:justify-center">

    <div class="w-screen sm:w-full bg-transparent sm:bg-white max-w-none p-0 sm:p-4 md:p-6 rounded-none shadow-none sm:rounded-lg sm:shadow-xl">
        <div class="flex flex-col items-center mb-3 sm:mb-4">
            <div class="flex justify-center items-center gap-3 sm:gap-4">
                <button id="clearBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Clear
                </button>
                <button id="totalAudioBtn" title="Play Total Scores" aria-label="Play Total Scores" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M5 3v18l14-9L5 3z" /> 
                    </svg>
                </button>
                <button id="editToggleBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-2 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg id="lockIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <svg id="editIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </button>
                <button id="playerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Player
                </button>
            </div>
        </div>

        <audio id="playbackAudio" preload="auto" class="hidden"></audio>

        <div class="overflow-x-hidden overflow-y-auto max-h-[70vh] rounded-none sm:rounded-lg">
            <table class="w-full table-auto divide-y divide-gray-200 rounded-none sm:rounded-lg overflow-hidden border-0 sm:border sm:border-gray-200">
                <thead class="bg-blue-600 text-white sticky top-0 z-10 shadow">
                    <tr id="tableHeaderRow">
                        </tr>
                </thead>
                <tbody id="sumRow" class="bg-blue-50 font-bold text-gray-800">
                    <tr>
                        </tr>
                </tbody>
                <tbody id="dataBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>

        <div class="flex justify-center mt-3 sm:mt-4 items-center">
            <button id="addRoundBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Add Round
            </button>
        </div>
    </div>

    <div id="clearConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p class="text-lg font-semibold mb-4 text-gray-800">আপনি কি নিশ্চিত যে আপনি সমস্ত সংখ্যা মুছে ফেলতে চান?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmClearBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    হ্যাঁ
                </button>
                <button id="cancelClearBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    না
                </button>
            </div>
        </div>
    </div>
    
    <div id="playerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content w-full max-w-sm mx-auto p-6 rounded-lg shadow-xl">
            <p class="text-lg font-semibold mb-4 text-gray-800 text-center">খেলোয়াড় নির্বাচন করুন</p>
            <p class="text-sm text-gray-600 mb-4 text-center">সর্বোচ্চ ৪ জন খেলোয়াড় নির্বাচন করা যাবে</p>
            <div id="playerListContainer" class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-2 mb-4 space-y-2">
                </div>
            <div class="flex justify-center space-x-4">
                <button id="savePlayerListBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Save
                </button>
                <button id="cancelPlayerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    বাতিল
                </button>
            </div>
            <hr class="my-4 border-gray-300">
            <div class="flex space-x-2">
                <input type="text" id="addPlayerInput" placeholder="নতুন নাম যোগ করুন" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="addPlayerBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    যোগ করুন
                </button>
            </div>
        </div>
    </div>
    
    <div id="dynamicPlayerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content w-full max-w-xs mx-auto p-6 rounded-lg shadow-xl">
            <p class="text-lg font-semibold mb-4 text-gray-800 text-center">খেলোয়াড় নির্বাচন করুন</p>
            <div id="dynamicPlayerList" class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-2 mb-4 space-y-2">
                </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelDynamicPlayerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    বাতিল
                </button>
            </div>
        </div>
    </div>

    <script>
        // Use a single script block for all JavaScript logic.
        document.addEventListener('DOMContentLoaded', () => {
            // State management using plain JavaScript variables
            let columnNames = ['হামিম', 'সোহেল', 'চঞ্চল', 'আকিজ'];
            let numRows = 1; // start with a single round by default
            const subtractValue = 360;
            let isLocked = true; // Default state is locked
            
            let presetPlayers = [
                'হামিম', 'সোহেল', 'চঞ্চল', 'আকিজ', 'সুমন', 'ফয়ছাল', 'নাঈম', 'মওলা', 'পলাশ', 'ইমরান', 'জসিম'
            ];
            
            let rowData = [];
            let currentColumnIndex = -1; // To track which column is being edited

            // Keep players sorted alphabetically (A..Z) using Bengali locale when available
            const sortPlayers = () => {
                try {
                    presetPlayers.sort((a, b) => a.localeCompare(b, 'bn', { sensitivity: 'base' }));
                } catch (e) {
                    // Fallback if locale not supported
                    presetPlayers.sort((a, b) => a.localeCompare(b));
                }
            };

            // সেভ করা ডেটা লোড করার জন্য একটি ফাংশন
            const loadData = () => {
                const savedData = localStorage.getItem('calculatorData');
                const savedPlayers = localStorage.getItem('playerNames');
                const savedLockState = localStorage.getItem('isLocked');
                
                if (savedPlayers) {
                    try {
                        presetPlayers = JSON.parse(savedPlayers);
                        sortPlayers();
                    } catch (e) {
                        console.error("Failed to parse saved player names.", e);
                    }
                }

                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        columnNames = parsedData.columnNames || ['হামিম', 'সোহেল', 'চঞ্চল', 'আকিজ'];
                        rowData = Array.isArray(parsedData.rowData) ? parsedData.rowData : [];
                        numRows = Math.max(1, rowData.length || 1);
                        // Ensure all rows have all columns and proper ids
                        rowData = Array.from({ length: numRows }, (_, i) => {
                            const row = parsedData.rowData && parsedData.rowData[i] ? { ...parsedData.rowData[i] } : { id: i };
                            row.id = i;
                            columnNames.forEach(name => {
                                if (typeof row[name] === 'undefined') row[name] = '';
                            });

            // Handle edit/cancel for previous rounds
            dataBody.addEventListener('click', (event) => {
                const editBtn = event.target.closest('.edit-round-btn');
                if (editBtn) {
                    const idx = parseInt(editBtn.dataset.rowIndex, 10);
                    if (!isNaN(idx) && rowData[idx]) {
                        // save snapshot
                        rowData[idx]._saved = { ...rowData[idx] };
                        rowData[idx].isEditing = true;
                        saveData();
                        renderTable();
                    }
                    return;
                }
                const cancelBtn = event.target.closest('.cancel-edit-btn');
                if (cancelBtn) {
                    const idx = parseInt(cancelBtn.dataset.rowIndex, 10);
                    if (!isNaN(idx) && rowData[idx]) {
                        if (rowData[idx]._saved) {
                            const snap = rowData[idx]._saved;
                            // restore saved values for all columns
                            columnNames.forEach(n => { rowData[idx][n] = snap[n] ?? ''; });
                            delete rowData[idx]._saved;
                        }
                        rowData[idx].isEditing = false;
                        saveData();
                        renderTable();
                    }
                    return;
                }
                const saveBtn = event.target.closest('.save-edit-btn');
                if (saveBtn) {
                    const idx = parseInt(saveBtn.dataset.rowIndex, 10);
                    if (!isNaN(idx) && rowData[idx]) {
                        // finalize edits: drop snapshot and exit edit mode
                        if (rowData[idx]._saved) delete rowData[idx]._saved;
                        rowData[idx].isEditing = false;
                        saveData();
                        renderTable();
                    }
                }
            });
                            return row;
                        });
                    } catch (e) {
                        console.error("Failed to parse saved data from localStorage, resetting.", e);
                        numRows = 1;
                        rowData = initializeRowData();
                    }
                } else {
                    numRows = 1;
                    rowData = initializeRowData();
                }

                if (savedLockState !== null) {
                    isLocked = JSON.parse(savedLockState);
                }
            };
            
            // ডেটা সেভ করার জন্য একটি ফাংশন
            const saveData = () => {
                localStorage.setItem('calculatorData', JSON.stringify({ columnNames, rowData }));
                localStorage.setItem('playerNames', JSON.stringify(presetPlayers));
                localStorage.setItem('isLocked', JSON.stringify(isLocked));
            };

            // Initializing with empty strings
            const initializeRowData = () => {
                const initialData = [];
                for (let i = 0; i < numRows; i++) {
                    const row = { id: i };
                    columnNames.forEach(name => {
                        row[name] = '';
                    });
                    initialData.push(row);
                }
                return initialData;
            };

            // DOM element references
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const sumRowBody = document.getElementById('sumRow').querySelector('tr');
            const dataBody = document.getElementById('dataBody');
            const clearBtn = document.getElementById('clearBtn');
            const editToggleBtn = document.getElementById('editToggleBtn');
            const lockIcon = document.getElementById('lockIcon');
            const editIcon = document.getElementById('editIcon');
            const clearConfirmModal = document.getElementById('clearConfirmModal');
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            const playerBtn = document.getElementById('playerBtn'); // Direct reference to the player button
            // RENAMED REFERENCE: Old speakBtn is now totalAudioBtn
            const totalAudioBtn = document.getElementById('totalAudioBtn');
            const playbackAudio = document.getElementById('playbackAudio'); // Reference to the hidden audio element

            let addRoundBtn = null; // will be set after we add it to the DOM
            const playerModal = document.getElementById('playerModal');
            const playerListContainer = document.getElementById('playerListContainer');
            const savePlayerListBtn = document.getElementById('savePlayerListBtn');
            const cancelPlayerBtn = document.getElementById('cancelPlayerBtn');
            const addPlayerInput = document.getElementById('addPlayerInput');
            const addPlayerBtn = document.getElementById('addPlayerBtn');
            const dynamicPlayerModal = document.getElementById('dynamicPlayerModal');
            const dynamicPlayerList = document.getElementById('dynamicPlayerList');
            const cancelDynamicPlayerBtn = document.getElementById('cancelDynamicPlayerBtn');


            // --- Calculation Functions ---
            
            // Calculates the sum for a single column.
            const calculateColumnSum = (colName) => {
                return rowData.reduce((sum, row) => {
                    const value = parseFloat(row[colName]);
                    return sum + (isNaN(value) ? 0 : value);
                }, 0);
            };

            // Utility: convert digits to Bengali numerals (e.g., 123 -> ১২৩)
            const toBnDigits = (n) => {
                const map = '০১২৩৪৫৬৭৮৯';
                const s = Math.round(Number(n || 0)).toString();
                return s.replace(/[0-9]/g, d => map[d]);
            };
            // Utility: spaced Bengali digits to force pronunciation (e.g., ১২৩ -> ১ ২ ৩)
            const toBnDigitsSpaced = (n) => toBnDigits(n).split('').join(' ');

            // Utility: Convert number to Bengali words (Bangladesh style) for common ranges.
            // THIS FUNCTION IS NO LONGER USED FOR AUDIO, BUT KEPT FOR REFERENCE/FALLBACK
            const toBnWords = (num) => {
                num = Math.round(Number(num || 0));
                if (!isFinite(num) || num < 0) return toBnDigitsSpaced(num);

                const ones = ['শূন্য','এক','দুই','তিন','চার','পাঁচ','ছয়','সাত','আট','নয়'];
                const teens = {
                    10:'দশ',11:'এগারো',12:'বারো',13:'তেরো',14:'চৌদ্দ',15:'পনেরো',16:'ষোলো',17:'সতেরো',18:'আঠারো',19:'উনিশ'
                };
                const tens = {20:'কুড়ি',30:'তিরিশ',40:'চল্লিশ',50:'পঞ্চাশ',60:'ষাট',70:'সত্তর',80:'আশি',90:'নব্বই'};
                const twenties = {21:'একুশ',22:'বাইশ',23:'তেইশ',24:'চব্বিশ',25:'পঁচিশ',26:'ছাব্বিশ',27:'সাতাশ',28:'আঠাশ',29:'উনত্রিশ'};
                const thirties = {31:'একত্রিশ',32:'বত্রিশ',33:'তেত্রিশ',34:'চৌত্রিশ',35:'পঁয়ত্রিশ',36:'ছত্রিশ',37:'সাঁইত্রিশ',38:'আটত্রিশ',39:'উনচল্লিশ'};
                const forties = {41:'একচল্লিশ',42:'বিয়াল্লিশ',43:'তেতাল্লিশ',44:'চুয়াল্লিশ',45:'পঁয়তাল্লিশ',46:'ছেচল্লিশ',47:'সাতচল্লিশ',48:'আটচল্লিশ',49:'উনপঞ্চাশ'};
                const fifties = {51:'একান্ন',52:'বাহান্ন',53:'তিপ্পান্ন',54:'চুয়ান্ন',55:'পঞ্চান্ন',56:'ছাপ্পান্ন',57:'সাতান্ন',58:'আটান্ন',59:'উনষাট'};
                const sixties = {61:'একষট্টি',62:'বাষট্টি',63:'তেষট্টি',64:'চৌষট্টি',65:'পঁয়ষট্টি',66:'ছেষট্টি',67:'সাতষট্টি',68:'আটষট্টি',69:'উনসত্তর'};
                const seventies = {71:'একাত্তর',72:'বাহাত্তর',73:'তেহাত্তর',74:'চুয়াত্তর',75:'পঁচাত্তর',76:'ছিয়াত্তর',77:'সাতাত্তর',78:'আটাত্তর',79:'উনআশি'};
                const eighties = {81:'একাশি',82:'বিরাশি',83:'তিরাশি',84:'চুরাশি',85:'পঁচাশি',86:'ছিয়াশি',87:'সাতাশি',88:'অষ্টাশি',89:'উননব্বই'};
                const nineties = {91:'একানব্বই',92:'বিরানব্বই',93:'তিরানব্বই',94:'চুরানব্বই',95:'পঁচানব্বই',96:'ছিয়ানব্বই',97:'সাতানব্বই',98:'আটানব্বই',99:'নিরানব্বই'};
                const maps2 = [twenties, thirties, forties, fifties, sixties, seventies, eighties, nineties];

                if (num < 10) return ones[num];
                if (num >= 10 && num < 20) return teens[num];
                if (num % 10 === 0 && num < 100) return tens[num] || toBnDigitsSpaced(num);
                if (num > 20 && num < 100) {
                    for (const m of maps2) if (m[num]) return m[num];
                    // Fallback composition (may be less natural): tens + ones
                    const t = Math.floor(num/10)*10; const r = num%10;
                    return `${tens[t] || toBnDigitsSpaced(t)} ${ones[r]}`;
                }

                // Hundreds
                if (num < 1000) {
                    const hundredsWord = ['','একশ','দুইশ','তিনশ','চারশ','পাঁচশ','ছয়শ','সাতশ','আটশ','নয়শ'];
                    const h = Math.floor(num/100);
                    const r = num % 100;
                    const hWord = hundredsWord[h];
                    if (r === 0) return hWord;
                    const rWord = toBnWords(r);
                    return `${hWord} ${rWord}`;
                }

                // Thousands (simple): x হাজার y
                if (num < 100000) {
                    const th = Math.floor(num/1000);
                    const r = num % 1000;
                    const thWord = th === 1 ? 'এক হাজার' : `${toBnWords(th)} হাজার`;
                    if (r === 0) return thWord;
                    return `${thWord} ${toBnWords(r)}`;
                }

                // Fallback for larger numbers
                return toBnDigitsSpaced(num);
            };

            // Calculates the sum of the first four columns for a given row.
            const calculateSumOfFirstFourColumns = (row) => {
                const firstFourNames = columnNames.slice(0, 4);
                return firstFourNames.reduce((sum, colName) => {
                    const value = parseFloat(row[colName]);
                    return sum + (isNaN(value) ? 0 : value);
                }, 0);
            };

            // Calculates the row total by subtracting the constant value.
            const calculateRowTotal = (row) => {
                const sumOfFirstFour = calculateSumOfFirstFourColumns(row);
                return sumOfFirstFour - subtractValue;
            };

            // --- Audio Playback Logic (Simulating MP3 Sequence) ---
            
            // NOTE: This function assumes you have a folder named '/audio/' containing
            // MP3 files for each player name and a score file (e.g., 'SCORE_123.mp3').
            // The score part uses a placeholder MP3 (silent.mp3) for numbers due to the
            // impossibility of hosting dynamic score MP3s in this environment.

            const getAudioUrls = () => {
                const firstFour = columnNames.slice(0, 4);
                const items = firstFour.map(name => ({
                    name,
                    total: Math.round(calculateColumnSum(name))
                }));
                
                let audioQueue = [];

                items.forEach(({ name, total }) => {
                    // 1. Player Name MP3 (e.g., /audio/হামিম.mp3)
                    // We must use a simple URL slug for player names, e.g., 'hamim.mp3',
                    // as server filenames don't typically use Bengali.
                    const nameSlug = name.replace(/\s/g, '_'); // Replace spaces for URL
                    audioQueue.push(`/audio/${nameSlug}.mp3`);

                    // 2. The Total Score MP3 (e.g., /audio/SCORE_123.mp3)
                    // We must use a number-based MP3 since generating an MP3 for every number-word sequence is impractical.
                    // For example, an MP3 for "Minus 120" or "Plus 300".
                    // Since I cannot host these, I will use a placeholder 'silent.mp3' here
                    // to keep the code structure correct.
                    const scoreUrl = `/audio/SCORE_${total}.mp3`;
                    audioQueue.push(scoreUrl);
                });

                return audioQueue;
            };

            // Recursive function to play a sequence of audio files
            const playSequence = (audioUrls, index = 0) => {
                if (index >= audioUrls.length) {
                    totalAudioBtn.disabled = false; // Re-enable button
                    return;
                }

                playbackAudio.src = audioUrls[index];
                
                // Set the event listener for when the current audio ends
                const onEnded = () => {
                    playbackAudio.removeEventListener('ended', onEnded);
                    playSequence(audioUrls, index + 1); // Play the next item
                };
                
                playbackAudio.addEventListener('ended', onEnded);
                
                // Play the audio
                playbackAudio.play().catch(e => {
                    console.error("Audio playback failed for:", audioUrls[index], e);
                    // Skip to the next one if it fails (e.g., MP3 not found)
                    onEnded(); 
                });
            };

            // --- Update Functions ---
            
            // Updates only the calculated sums and totals without re-rendering the whole table.
            const updateTableTotals = () => {
                // Helper: format numbers as integers (no decimals)
                const formatInt = (n) => {
                    const num = Number(n);
                    if (!isFinite(num)) return '0';
                    return Math.round(num).toString();
                };
                // Update Sums Row
                const columnSums = columnNames.reduce((acc, name) => {
                    acc[name] = calculateColumnSum(name);
                    return acc;
                }, {});

                const rankedColumnColors = {};
                if (Object.keys(columnSums).length > 0) {
                    const rankableSums = columnNames.slice(0, 4).map(name => ({
                        name: name,
                        sum: columnSums[name]
                    }));
                    rankableSums.sort((a, b) => b.sum - a.sum);

                    if (rankableSums[0]) rankedColumnColors[rankableSums[0].name] = 'text-green-600';
                    if (rankableSums[1]) rankedColumnColors[rankableSums[1].name] = 'text-blue-600';
                    if (rankableSums[2]) rankedColumnColors[rankableSums[2].name] = 'text-yellow-600';
                    if (rankableSums[3]) rankedColumnColors[rankableSums[3].name] = 'text-red-600';
                }

                columnNames.forEach((name, index) => {
                    // Offset by 1 due to the leading (edit) column in the sums row
                    const td = sumRowBody.children[index + 1];
                    td.textContent = formatInt(columnSums[name]);
                    td.className = `px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-xl font-extrabold text-center ${rankedColumnColors[name] || ''}`;
                });

                // Update Data Rows Totals
                dataBody.querySelectorAll('tr').forEach((rowElement, rowIndex) => {
                    const row = rowData[rowIndex];
                    const rowTotal = calculateRowTotal(row);
                    const totalCell = rowElement.querySelector('.total-cell');
                    const totalTextColorClass = rowTotal > 0 ? 'text-red-600' : 'text-gray-700';
                    
                    if (totalCell) {
                        totalCell.textContent = formatInt(rowTotal);
                        totalCell.className = `px-1 py-1 sm:px-2 sm:py-2 whitespace-nowrap text-lg font-semibold text-center bg-blue-50 ${totalTextColorClass} total-cell`;
                    }
                });
            };

            // Renders the entire table from scratch. This is only called on initial load and for the clear action.
            const renderTable = () => {
                // Clear existing table content
                tableHeaderRow.innerHTML = '';
                sumRowBody.innerHTML = '';
                dataBody.innerHTML = '';

                // Render Header Row
                // Add leading empty header (edit column only, no round numbers)
                const roundHeader = document.createElement('th');
                roundHeader.className = "table-cell-padding text-center text-xs font-medium uppercase tracking-wider";
                roundHeader.scope = "col";
                roundHeader.textContent = "";
                tableHeaderRow.appendChild(roundHeader);

                columnNames.forEach((name, index) => {
                    const th = document.createElement('th');
                    th.className = "table-cell-padding text-center text-sm md:text-base font-semibold uppercase tracking-wider";
                    th.scope = "col";
                    if(isLocked) {
                        th.innerHTML = `
                            <span data-col-index="${index}" title="${name}" class="cursor-pointer bg-transparent border-b border-white focus:outline-none text-center text-white placeholder-gray-300 w-12 sm:w-16 md:w-28 rounded-sm px-1 py-0.5 text-sm md:text-lg whitespace-nowrap overflow-hidden text-ellipsis truncate">${name}</span>
                        `;
                    } else {
                        th.innerHTML = `
                            <span data-col-index="${index}" title="${name}" class="cursor-pointer bg-transparent border-b border-white focus:outline-none text-center text-white placeholder-gray-300 w-12 sm:w-16 md:w-28 rounded-sm px-1 py-0.5 text-sm md:text-lg whitespace-nowrap overflow-hidden text-ellipsis truncate">${name}</span>
                        `;
                    }
                    tableHeaderRow.appendChild(th);
                });
                const totalTh = document.createElement('th');
                totalTh.className = "table-cell-padding text-center text-xs font-medium uppercase tracking-wider";
                totalTh.scope = "col";
                totalTh.textContent = "Total";
                tableHeaderRow.appendChild(totalTh);

                // Render Sums Row (placeholder for updateTableTotals)
                // Leading empty for Round column
                const roundEmpty = document.createElement('td');
                roundEmpty.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-sm text-center";
                sumRowBody.appendChild(roundEmpty);
                columnNames.forEach(() => {
                    const td = document.createElement('td');
                    td.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-xl font-extrabold text-center";
                    sumRowBody.appendChild(td);
                });
                const emptySumTd = document.createElement('td');
                emptySumTd.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-sm text-center bg-blue-200";
                sumRowBody.appendChild(emptySumTd);

                // Render all rounds so previous rounds remain visible
                rowData.forEach((row, rowIndexVisible) => {
                    const rowElement = document.createElement('tr');
                    const rowHasAnyValue = columnNames.some(name => {
                        const v = row[name];
                        return v !== null && v !== undefined && v.toString().trim() !== '';
                    });
                    const initialBg = rowHasAnyValue ? 'bg-yellow-50' : (rowIndexVisible % 2 === 0 ? 'bg-gray-50' : 'bg-white');
                    rowElement.className = `border-b ${initialBg} hover:bg-sky-50 transition-colors`;
                    // Use the global index from row.id for updates to rowData
                    const globalRowIndex = typeof row.id === 'number' ? row.id : rowIndexVisible;
                    const isLastRow = (rowIndexVisible === rowData.length - 1);

                    // Round index + edit/cancel controls cell
                    const roundTd = document.createElement('td');
                    roundTd.className = "px-2 py-1 whitespace-nowrap text-sm text-gray-700 text-center";
                    let controls = '';
                    if (!isLastRow) {
                        if (row.isEditing) {
                            controls = `
                                <div class="flex items-center gap-2">
                                    <button class=\"cancel-edit-btn bg-red-500 hover:bg-red-600 text-white p-1 rounded-full transition duration-150\" data-row-index=\"${globalRowIndex}\">
                                        <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" /></svg>
                                    </button>
                                    <button class=\"save-edit-btn bg-green-500 hover:bg-green-600 text-white p-1 rounded-full transition duration-150\" data-row-index=\"${globalRowIndex}\">
                                        <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\"><path fill-rule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L7 12.586l7.293-7.293a1 1 0 011.414 0z\" clip-rule=\"evenodd\" /></svg>
                                    </button>
                                </div>`;
                        } else {
                            controls = `
                                <button class="edit-round-btn bg-gray-200 hover:bg-gray-300 text-gray-800 p-1 rounded-full transition duration-150" data-row-index="${globalRowIndex}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </button>`;
                        }
                    }
                    roundTd.innerHTML = `<div class="flex items-center justify-center">${controls}</div>`;
                    rowElement.appendChild(roundTd);
                    
                    columnNames.forEach((colName, colIndex) => {
                        const cell = document.createElement('td');
                        cell.className = "px-1 py-1 sm:px-2 sm:py-2 whitespace-nowrap text-sm text-gray-900 text-center";
                        if (isLastRow || row.isEditing) {
                            // Active round: editable inputs
                            cell.innerHTML = `
                                <input
                                    type="number"
                                    value="${row[colName]}"
                                    data-row-index-global="${globalRowIndex}"
                                    data-col-name="${colName}"
                                    class="responsive-input w-12 sm:w-16 md:w-28 border rounded-lg px-1.5 py-1 text-center focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-colors ${row[colName] !== '' ? 'bg-gray-50 border-blue-300' : 'bg-white border-gray-300'}"
                                />
                            `;
                        } else {
                            // Previous rounds: read-only display with 0 if empty, Call Bridge style (+/- and color)
                            const numRaw = (row[colName] === '' || row[colName] === undefined || row[colName] === null) ? 0 : parseFloat(row[colName]);
                            const val = isNaN(numRaw) ? 0 : numRaw;
                            const text = `${val}`; // no '+' sign in Hazari
                            const color = val > 0 ? 'text-emerald-600' : (val < 0 ? 'text-rose-600' : 'text-gray-500');
                            cell.innerHTML = `
                                <span class="inline-block min-w-[3rem] px-1 py-0.5 rounded-md ${color} text-base font-semibold">${text}</span>
                            `;
                        }
                        rowElement.appendChild(cell);
                    });

                    // Render Total Cell
                    const totalCell = document.createElement('td');
                    const initialRowTotal = Math.round(calculateRowTotal(row));
                    const totalColorClass = initialRowTotal > 0
                        ? 'bg-rose-50 text-rose-600'
                        : (initialRowTotal < 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-100 text-gray-700');
                    totalCell.className = `px-2 py-1 sm:px-3 sm:py-1.5 whitespace-nowrap text-sm font-semibold text-center rounded-full ${totalColorClass} total-cell`;
                    totalCell.textContent = initialRowTotal.toString();
                    rowElement.appendChild(totalCell);

                    dataBody.appendChild(rowElement);
                });

                updateTableTotals();
            };
            
            // Render player list in the modal
            const renderPlayerList = () => {
                // Ensure list is sorted before rendering so indices align with the displayed order
                sortPlayers();
                playerListContainer.innerHTML = '';
                presetPlayers.forEach((player, index) => {
                    const playerItem = document.createElement('div');
                    playerItem.className = "flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 transition duration-150";
                    playerItem.innerHTML = `
                        <span class="text-lg font-semibold text-gray-800 flex-grow">${player}</span>
                        <div class="flex space-x-2">
                            <button class="edit-player-btn bg-yellow-400 text-white p-1 rounded-full hover:bg-yellow-500 transition duration-150" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <button class="delete-player-btn bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition duration-150" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                     <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    playerListContainer.appendChild(playerItem);
                });
            };
            
            // --- Event Handlers ---
            
            dataBody.addEventListener('input', (event) => {
                const target = event.target;
                if (target.tagName === 'INPUT' && target.type === 'number') {
                    const globalRowIndex = parseInt(target.dataset.rowIndexGlobal, 10);
                    const colName = target.dataset.colName;
                    const value = target.value;
                    
                    if (!isNaN(globalRowIndex) && colName) {
                        rowData[globalRowIndex][colName] = value;
                        saveData();
                        
                        // Update sums and totals after all data and display logic is handled
                        updateTableTotals();

                        // Subtle style difference: filled vs empty inputs
                        const isFilled = (value !== null && value !== undefined && value.toString().trim() !== '');
                        target.classList.remove('bg-white', 'border-gray-300', 'bg-gray-50', 'border-blue-300');
                        if (isFilled) {
                            target.classList.add('bg-gray-50', 'border-blue-300');
                        } else {
                            target.classList.add('bg-white', 'border-gray-300');
                        }

                        // Row highlight: if any cell in this row has a value, highlight the whole row
                        const rowEl = target.closest('tr');
                        const rowHasAny = columnNames.some(n => {
                            const v = (rowData[globalRowIndex][n] ?? '').toString().trim();
                            return v !== '';
                        });
                        rowEl.classList.remove('bg-white','bg-gray-50','bg-yellow-50');
                        rowEl.classList.add(rowHasAny ? 'bg-yellow-50' : 'bg-white');
                    }
                }
            });
            
            clearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.remove('hidden');
            });

            confirmClearBtn.addEventListener('click', () => {
                numRows = 1;
                rowData = initializeRowData();
                renderTable();
                clearConfirmModal.classList.add('hidden');
                localStorage.removeItem('calculatorData');
            });

            cancelClearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.add('hidden');
            });
            
            editToggleBtn.addEventListener('click', () => {
                isLocked = !isLocked;
                lockIcon.classList.toggle('hidden', !isLocked);
                editIcon.classList.toggle('hidden', isLocked);
                playerBtn.classList.toggle('hidden', isLocked); // This line now controls the player button
                renderTable();
                saveData();
            });

            playerBtn.addEventListener('click', () => {
                renderPlayerList();
                playerModal.classList.remove('hidden');
                document.getElementById('addPlayerInput').value = '';
                addPlayerBtn.textContent = 'যোগ করুন';
            });

            // AUDIO PLAYBACK BUTTON HANDLER (Replaced old speakBtn logic)
            totalAudioBtn.addEventListener('click', () => {
                totalAudioBtn.disabled = true; // Disable while playing
                playbackAudio.pause(); // Stop any currently playing audio
                playbackAudio.currentTime = 0;
                
                const urls = getAudioUrls();
                if (urls.length > 0) {
                    playSequence(urls);
                } else {
                    totalAudioBtn.disabled = false;
                }
            });
            // END AUDIO PLAYBACK HANDLER

            cancelPlayerBtn.addEventListener('click', () => {
                playerModal.classList.add('hidden');
            });

            playerListContainer.addEventListener('click', (event) => {
                const target = event.target.closest('.edit-player-btn');
                if (target) {
                    const index = parseInt(target.dataset.index, 10);
                    const playerName = presetPlayers[index];
                    const playerItem = target.closest('.flex');
                    const nameSpan = playerItem.querySelector('span');

                    nameSpan.style.display = 'none';
                    playerItem.querySelector('.flex-grow').innerHTML = `
                        <input type="text" value="${playerName}" class="edit-player-input w-full px-2 py-1 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    playerItem.querySelector('.edit-player-input').focus();
                    target.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                    target.classList.remove('bg-yellow-400');
                    target.classList.add('bg-green-500');
                    target.classList.remove('edit-player-btn');
                    target.classList.add('save-player-btn');

                    const deleteBtn = playerItem.querySelector('.delete-player-btn');
                    deleteBtn.style.display = 'none';
                    return;
                }

                const deleteTarget = event.target.closest('.delete-player-btn');
                if (deleteTarget) {
                    const index = parseInt(deleteTarget.dataset.index, 10);
                    // Use a custom modal instead of alert
                    const modal = document.createElement('div');
                    modal.id = "deleteConfirmModal";
                    modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50";
                    modal.innerHTML = `
                      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4 text-gray-800">আপনি কি নিশ্চিত যে আপনি এই খেলোয়াড়কে মুছে ফেলতে চান?</p>
                        <div class="flex justify-center space-x-4">
                          <button id="confirmDeleteBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">হ্যাঁ</button>
                          <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md">না</button>
                        </div>
                      </div>
                    `;
                    document.body.appendChild(modal);

                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                      presetPlayers.splice(index, 1);
                      saveData();
                      renderPlayerList();
                      modal.remove();
                    });

                    document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                      modal.remove();
                    });
                    return;
                }
                
                const saveTarget = event.target.closest('.save-player-btn');
                if (saveTarget) {
                    const index = parseInt(saveTarget.dataset.index, 10);
                    const newName = saveTarget.closest('.flex').querySelector('.edit-player-input').value.trim();
                    if (newName) {
                        presetPlayers[index] = newName;
                        saveData();
                        renderPlayerList();
                    }
                    return;
                }
            });

            addPlayerBtn.addEventListener('click', () => {
                const newName = addPlayerInput.value.trim();
                if (newName && !presetPlayers.includes(newName)) {
                    presetPlayers.push(newName);
                    sortPlayers();
                    addPlayerInput.value = '';
                    saveData();
                    renderPlayerList();
                } else if (newName) {
                    // Use a custom modal for alert
                    const modal = document.createElement('div');
                    modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50";
                    modal.innerHTML = `
                      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4 text-gray-800">এই নামটি ইতিমধ্যে তালিকায় আছে।</p>
                        <button id="closeAlertBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">ঠিক আছে</button>
                      </div>
                    `;
                    document.body.appendChild(modal);
                    document.getElementById('closeAlertBtn').addEventListener('click', () => {
                      modal.remove();
                    });
                }
            });

            // Add Round functionality
            const setupAddRound = () => {
                addRoundBtn = document.getElementById('addRoundBtn');
                if (!addRoundBtn) return;
                // Always keep Add Round enabled
                addRoundBtn.disabled = false;
                addRoundBtn.classList.remove('bg-gray-400','cursor-not-allowed');
                addRoundBtn.classList.add('bg-green-500');
                addRoundBtn.onclick = () => {
                    numRows += 1;
                    const newRow = { id: rowData.length };
                    columnNames.forEach(name => { newRow[name] = ''; });
                    rowData.push(newRow);
                    saveData();
                    renderTable();
                };
            };

            savePlayerListBtn.addEventListener('click', () => {
                // Sort before saving to keep persistent order
                sortPlayers();
                playerModal.classList.add('hidden');
                saveData(); // Save the updated list when the modal is closed
            });
            
            // প্লেয়ারের নাম নির্বাচন করা হলে, এই ইভেন্টটি টেবিলের হেডার আপডেট করবে।
            dynamicPlayerList.addEventListener('click', (event) => {
                const target = event.target.closest('div');
                if (target && target.dataset.name) {
                    const selectedName = target.dataset.name;
                    if (currentColumnIndex !== -1 && currentColumnIndex < columnNames.length) {
                        const oldName = columnNames[currentColumnIndex];
                        columnNames[currentColumnIndex] = selectedName;
                        
                        // rowData-এর অবজেক্টগুলি সরাসরি আপডেট করা হচ্ছে।
                        rowData.forEach(row => {
                            if (typeof row[oldName] !== 'undefined') {
                                row[selectedName] = row[oldName];
                                delete row[oldName];
                            }
                        });
                        
                        // Update the span element with the new name
                        const headerSpan = tableHeaderRow.querySelector(`span[data-col-index="${currentColumnIndex}"]`);
                        if(headerSpan) {
                            headerSpan.textContent = selectedName;
                        }

                        updateTableTotals();
                        saveData();
                    }
                    dynamicPlayerModal.classList.add('hidden');
                    currentColumnIndex = -1; // Reset index after selection
                }
            });
            
            cancelDynamicPlayerBtn.addEventListener('click', () => {
                dynamicPlayerModal.classList.add('hidden');
                currentColumnIndex = -1;
            });
            
            // প্লেয়ারের নাম ইনপুট ফিল্ডে ক্লিক করলে কিবোর্ড বন্ধ রাখার জন্য এই ইভেন্টটি আপডেট করা হলো।
            // Now we listen for a click on the span instead of input focus.
            tableHeaderRow.addEventListener('click', (event) => {
                const target = event.target.closest('span');
                if (target && !isLocked) {
                    const colIndex = parseInt(target.dataset.colIndex, 10);
                    currentColumnIndex = colIndex;

                    dynamicPlayerList.innerHTML = '';
                    // Ensure sorted order in the dynamic list as well
                    sortPlayers();
                    presetPlayers.forEach(player => {
                        const playerItem = document.createElement('div');
                        playerItem.className = "cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition duration-150 text-lg font-semibold text-gray-800";
                        playerItem.textContent = player;
                        playerItem.dataset.name = player;
                        dynamicPlayerList.appendChild(playerItem);
                    });
                    dynamicPlayerModal.classList.remove('hidden');
                }
            });
            
            // Initial render
            loadData();
            lockIcon.classList.toggle('hidden', !isLocked);
            editIcon.classList.toggle('hidden', isLocked);
            playerBtn.classList.toggle('hidden', isLocked);
            renderTable();
            setupAddRound();
        });
    </script>
</body>
</html>
