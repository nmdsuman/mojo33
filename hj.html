<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for consistency and style */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hiding the number input spinners for a cleaner UI */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Modal styling */
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 640px) {
            .table-cell-padding {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            .responsive-input {
                width: 3rem; /* narrower inputs on mobile to avoid horizontal overflow */
            }
            /* Prevent horizontal scroll on mobile */
            .no-x-overflow {
                overflow-x: hidden;
            }
            /* Make table fit within viewport width */
            table {
                table-layout: fixed;
                width: 100%;
            }
            thead th, tbody td {
                word-break: break-word;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen overflow-x-hidden">

    <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-4xl md:p-6">
        <!-- Application Title removed to eliminate extra blank space -->

        <!-- Clear Button, Toggle Switch and Player Button -->
        <div class="flex flex-col items-center mb-4 space-y-4">
            <div class="flex justify-center items-center space-x-4">
                <button id="clearBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Clear
                </button>
                <button id="speakBtn" title="Speak" aria-label="Speak" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14a3 3 0 003-3V7a3 3 0 10-6 0v4a3 3 0 003 3z"/>
                        <path d="M19 11a1 1 0 10-2 0 5 5 0 11-10 0 1 1 0 10-2 0 7 7 0 0012 4.9V18a1 1 0 112 0v-2.1A7 7 0 0019 11z"/>
                    </svg>
                </button>
                <!-- Edit Toggle Icon -->
                <button id="editToggleBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-2 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg id="lockIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <svg id="editIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </button>
                <!-- Player Button moved here -->
                <button id="playerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Player
                </button>
            </div>
        </div>

        <!-- Main Data Table Wrapper -->
        <div class="overflow-x-hidden">
            <table class="w-full table-auto divide-y divide-gray-200 rounded-lg overflow-hidden border border-gray-200">
                <thead class="bg-blue-600 text-white">
                    <tr id="tableHeaderRow">
                        <!-- Headers will be dynamically rendered here -->
                    </tr>
                </thead>
                <!-- Sums Row -->
                <tbody id="sumRow" class="bg-blue-100 font-bold text-gray-800">
                    <tr>
                        <!-- Sums will be dynamically rendered here -->
                    </tr>
                </tbody>
                <!-- Data Rows -->
                <tbody id="dataBody" class="bg-white divide-y divide-gray-200">
                    <!-- Data rows will be dynamically rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Confirmation Modal (initially hidden) -->
    <div id="clearConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p class="text-lg font-semibold mb-4 text-gray-800">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmClearBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶π‡ßç‡¶Ø‡¶æ‡¶Å
                </button>
                <button id="cancelClearBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶®‡¶æ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Player Selection Modal (initially hidden) -->
    <div id="playerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content w-full max-w-sm mx-auto p-6 rounded-lg shadow-xl">
            <p class="text-lg font-semibold mb-4 text-gray-800 text-center">‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <p class="text-sm text-gray-600 mb-4 text-center">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß™ ‡¶ú‡¶® ‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá</p>
            <div id="playerListContainer" class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-2 mb-4 space-y-2">
                <!-- Player names will be dynamically rendered here -->
            </div>
            <div class="flex justify-center space-x-4">
                <button id="savePlayerListBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Save
                </button>
                <button id="cancelPlayerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
            <hr class="my-4 border-gray-300">
            <div class="flex space-x-2">
                <input type="text" id="addPlayerInput" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="addPlayerBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
    
    <!-- Dynamic Player Selection Modal (initially hidden) -->
    <div id="dynamicPlayerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content w-full max-w-xs mx-auto p-6 rounded-lg shadow-xl">
            <p class="text-lg font-semibold mb-4 text-gray-800 text-center">‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <div id="dynamicPlayerList" class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-2 mb-4 space-y-2">
                <!-- Player names will be dynamically rendered here -->
            </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelDynamicPlayerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
        </div>
    </div>

    <script>
        // Use a single script block for all JavaScript logic.
        document.addEventListener('DOMContentLoaded', () => {
            // State management using plain JavaScript variables
            let columnNames = ['‡¶π‡¶æ‡¶Æ‡¶ø‡¶Æ', '‡¶∏‡ßã‡¶π‡ßá‡¶≤', '‡¶ö‡¶û‡ßç‡¶ö‡¶≤', '‡¶Ü‡¶ï‡¶ø‡¶ú'];
            const numRows = 20;
            const subtractValue = 360;
            let isLocked = true; // Default state is locked
            
            let presetPlayers = [
                '‡¶π‡¶æ‡¶Æ‡¶ø‡¶Æ', '‡¶∏‡ßã‡¶π‡ßá‡¶≤', '‡¶ö‡¶û‡ßç‡¶ö‡¶≤', '‡¶Ü‡¶ï‡¶ø‡¶ú', '‡¶∏‡ßÅ‡¶Æ‡¶®', '‡¶´‡¶Ø‡¶º‡¶õ‡¶æ‡¶≤', '‡¶®‡¶æ‡¶à‡¶Æ', '‡¶Æ‡¶ì‡¶≤‡¶æ', '‡¶™‡¶≤‡¶æ‡¶∂', '‡¶á‡¶Æ‡¶∞‡¶æ‡¶®', '‡¶ú‡¶∏‡¶ø‡¶Æ'
            ];
            
            let rowData = [];
            let currentColumnIndex = -1; // To track which column is being edited

            // Keep players sorted alphabetically (A..Z) using Bengali locale when available
            const sortPlayers = () => {
                try {
                    presetPlayers.sort((a, b) => a.localeCompare(b, 'bn', { sensitivity: 'base' }));
                } catch (e) {
                    // Fallback if locale not supported
                    presetPlayers.sort((a, b) => a.localeCompare(b));
                }
            };

            // ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
            const loadData = () => {
                const savedData = localStorage.getItem('calculatorData');
                const savedPlayers = localStorage.getItem('playerNames');
                const savedLockState = localStorage.getItem('isLocked');
                
                if (savedPlayers) {
                    try {
                        presetPlayers = JSON.parse(savedPlayers);
                        sortPlayers();
                    } catch (e) {
                        console.error("Failed to parse saved player names.", e);
                    }
                }

                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        columnNames = parsedData.columnNames || ['‡¶π‡¶æ‡¶Æ‡¶ø‡¶Æ', '‡¶∏‡ßã‡¶π‡ßá‡¶≤', '‡¶ö‡¶û‡ßç‡¶ö‡¶≤', '‡¶Ü‡¶ï‡¶ø‡¶ú'];
                        rowData = parsedData.rowData;
                        const initialData = [];
                        for (let i = 0; i < numRows; i++) {
                            const row = rowData[i] || { id: i };
                            columnNames.forEach(name => {
                                if (typeof row[name] === 'undefined') {
                                    row[name] = '';
                                }
                            });
                            initialData.push(row);
                        }
                        rowData = initialData;
                    } catch (e) {
                        console.error("Failed to parse saved data from localStorage, resetting.", e);
                        rowData = initializeRowData();
                    }
                } else {
                    rowData = initializeRowData();
                }

                if (savedLockState !== null) {
                    isLocked = JSON.parse(savedLockState);
                }
            };
            
            // ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
            const saveData = () => {
                localStorage.setItem('calculatorData', JSON.stringify({ columnNames, rowData }));
                localStorage.setItem('playerNames', JSON.stringify(presetPlayers));
                localStorage.setItem('isLocked', JSON.stringify(isLocked));
            };

            // Initializing with empty strings
            const initializeRowData = () => {
                const initialData = [];
                for (let i = 0; i < numRows; i++) {
                    const row = { id: i };
                    columnNames.forEach(name => {
                        row[name] = '';
                    });
                    initialData.push(row);
                }
                return initialData;
            };

            // DOM element references
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const sumRowBody = document.getElementById('sumRow').querySelector('tr');
            const dataBody = document.getElementById('dataBody');
            const clearBtn = document.getElementById('clearBtn');
            const editToggleBtn = document.getElementById('editToggleBtn');
            const lockIcon = document.getElementById('lockIcon');
            const editIcon = document.getElementById('editIcon');
            const clearConfirmModal = document.getElementById('clearConfirmModal');
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            const playerBtn = document.getElementById('playerBtn'); // Direct reference to the player button
            const speakBtn = document.getElementById('speakBtn');
            const playerModal = document.getElementById('playerModal');
            const playerListContainer = document.getElementById('playerListContainer');
            const savePlayerListBtn = document.getElementById('savePlayerListBtn');
            const cancelPlayerBtn = document.getElementById('cancelPlayerBtn');
            const addPlayerInput = document.getElementById('addPlayerInput');
            const addPlayerBtn = document.getElementById('addPlayerBtn');
            const dynamicPlayerModal = document.getElementById('dynamicPlayerModal');
            const dynamicPlayerList = document.getElementById('dynamicPlayerList');
            const cancelDynamicPlayerBtn = document.getElementById('cancelDynamicPlayerBtn');


            // --- Calculation Functions ---
            
            // Calculates the sum for a single column.
            const calculateColumnSum = (colName) => {
                return rowData.reduce((sum, row) => {
                    const value = parseFloat(row[colName]);
                    return sum + (isNaN(value) ? 0 : value);
                }, 0);
            };

            // Utility: convert digits to Bengali numerals (e.g., 123 -> ‡ßß‡ß®‡ß©)
            const toBnDigits = (n) => {
                const map = '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ';
                const s = Math.round(Number(n || 0)).toString();
                return s.replace(/[0-9]/g, d => map[d]);
            };
            // Utility: spaced Bengali digits to force pronunciation (e.g., ‡ßß‡ß®‡ß© -> ‡ßß ‡ß® ‡ß©)
            const toBnDigitsSpaced = (n) => toBnDigits(n).split('').join(' ');

            // Utility: Convert number to Bengali words (Bangladesh style) for common ranges.
            // Covers 0..9999 reasonably. Falls back to spaced digits for uncommon composites.
            const toBnWords = (num) => {
                num = Math.round(Number(num || 0));
                if (!isFinite(num) || num < 0) return toBnDigitsSpaced(num);

                const ones = ['‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø','‡¶è‡¶ï','‡¶¶‡ßÅ‡¶á','‡¶§‡¶ø‡¶®','‡¶ö‡¶æ‡¶∞','‡¶™‡¶æ‡¶Å‡¶ö','‡¶õ‡¶Ø‡¶º','‡¶∏‡¶æ‡¶§','‡¶Ü‡¶ü','‡¶®‡¶Ø‡¶º'];
                const teens = {
                    10:'‡¶¶‡¶∂',11:'‡¶è‡¶ó‡¶æ‡¶∞‡ßã',12:'‡¶¨‡¶æ‡¶∞‡ßã',13:'‡¶§‡ßá‡¶∞‡ßã',14:'‡¶ö‡ßå‡¶¶‡ßç‡¶¶',15:'‡¶™‡¶®‡ßá‡¶∞‡ßã',16:'‡¶∑‡ßã‡¶≤‡ßã',17:'‡¶∏‡¶§‡ßá‡¶∞‡ßã',18:'‡¶Ü‡¶†‡¶æ‡¶∞‡ßã',19:'‡¶â‡¶®‡¶ø‡¶∂'
                };
                const tens = {20:'‡¶ï‡ßÅ‡¶°‡¶º‡¶ø',30:'‡¶§‡¶ø‡¶∞‡¶ø‡¶∂',40:'‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',50:'‡¶™‡¶û‡ßç‡¶ö‡¶æ‡¶∂',60:'‡¶∑‡¶æ‡¶ü',70:'‡¶∏‡¶§‡ßç‡¶§‡¶∞',80:'‡¶Ü‡¶∂‡¶ø',90:'‡¶®‡¶¨‡ßç‡¶¨‡¶á'};
                const twenties = {21:'‡¶è‡¶ï‡ßÅ‡¶∂',22:'‡¶¨‡¶æ‡¶á‡¶∂',23:'‡¶§‡ßá‡¶á‡¶∂',24:'‡¶ö‡¶¨‡ßç‡¶¨‡¶ø‡¶∂',25:'‡¶™‡¶Å‡¶ö‡¶ø‡¶∂',26:'‡¶õ‡¶æ‡¶¨‡ßç‡¶¨‡¶ø‡¶∂',27:'‡¶∏‡¶æ‡¶§‡¶æ‡¶∂',28:'‡¶Ü‡¶†‡¶æ‡¶∂',29:'‡¶â‡¶®‡¶§‡ßç‡¶∞‡¶ø‡¶∂'};
                const thirties = {31:'‡¶è‡¶ï‡¶§‡ßç‡¶∞‡¶ø‡¶∂',32:'‡¶¨‡¶§‡ßç‡¶∞‡¶ø‡¶∂',33:'‡¶§‡ßá‡¶§‡ßç‡¶∞‡¶ø‡¶∂',34:'‡¶ö‡ßå‡¶§‡ßç‡¶∞‡¶ø‡¶∂',35:'‡¶™‡¶Å‡¶Ø‡¶º‡¶§‡ßç‡¶∞‡¶ø‡¶∂',36:'‡¶õ‡¶§‡ßç‡¶∞‡¶ø‡¶∂',37:'‡¶∏‡¶æ‡¶Å‡¶á‡¶§‡ßç‡¶∞‡¶ø‡¶∂',38:'‡¶Ü‡¶ü‡¶§‡ßç‡¶∞‡¶ø‡¶∂',39:'‡¶â‡¶®‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂'};
                const forties = {41:'‡¶è‡¶ï‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',42:'‡¶¨‡¶ø‡ßü‡¶æ‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',43:'‡¶§‡ßá‡¶§‡¶æ‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',44:'‡¶ö‡ßÅ‡ßü‡¶æ‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',45:'‡¶™‡¶Å‡¶Ø‡¶º‡¶§‡¶æ‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',46:'‡¶õ‡ßá‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',47:'‡¶∏‡¶æ‡¶§‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',48:'‡¶Ü‡¶ü‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂',49:'‡¶â‡¶®‡¶™‡¶û‡ßç‡¶ö‡¶æ‡¶∂'};
                const fifties = {51:'‡¶è‡¶ï‡¶æ‡¶®‡ßç‡¶®',52:'‡¶¨‡¶æ‡¶π‡¶æ‡¶®‡ßç‡¶®',53:'‡¶§‡¶ø‡¶™‡ßç‡¶™‡¶æ‡¶®‡ßç‡¶®',54:'‡¶ö‡ßÅ‡ßü‡¶æ‡¶®‡ßç‡¶®',55:'‡¶™‡¶û‡ßç‡¶ö‡¶æ‡¶®‡ßç‡¶®',56:'‡¶õ‡¶æ‡¶™‡ßç‡¶™‡¶æ‡¶®‡ßç‡¶®',57:'‡¶∏‡¶æ‡¶§‡¶æ‡¶®‡ßç‡¶®',58:'‡¶Ü‡¶ü‡¶æ‡¶®‡ßç‡¶®',59:'‡¶â‡¶®‡¶∑‡¶æ‡¶ü'};
                const sixties = {61:'‡¶è‡¶ï‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',62:'‡¶¨‡¶æ‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',63:'‡¶§‡ßá‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',64:'‡¶ö‡ßå‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',65:'‡¶™‡¶Å‡¶Ø‡¶º‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',66:'‡¶õ‡ßá‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',67:'‡¶∏‡¶æ‡¶§‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',68:'‡¶Ü‡¶ü‡¶∑‡¶ü‡ßç‡¶ü‡¶ø',69:'‡¶â‡¶®‡¶∏‡¶§‡ßç‡¶§‡¶∞'};
                const seventies = {71:'‡¶è‡¶ï‡¶æ‡¶§‡ßç‡¶§‡¶∞',72:'‡¶¨‡¶æ‡¶π‡¶æ‡¶§‡ßç‡¶§‡¶∞',73:'‡¶§‡ßá‡¶π‡¶æ‡¶§‡ßç‡¶§‡¶∞',74:'‡¶ö‡ßÅ‡¶Ø‡¶º‡¶æ‡¶§‡ßç‡¶§‡¶∞',75:'‡¶™‡¶Å‡¶ö‡¶æ‡¶§‡ßç‡¶§‡¶∞',76:'‡¶õ‡¶ø‡¶Ø‡¶º‡¶æ‡¶§‡ßç‡¶§‡¶∞',77:'‡¶∏‡¶æ‡¶§‡¶æ‡¶§‡ßç‡¶§‡¶∞',78:'‡¶Ü‡¶ü‡¶æ‡¶§‡ßç‡¶§‡¶∞',79:'‡¶â‡¶®‡¶Ü‡¶∂‡¶ø'};
                const eighties = {81:'‡¶è‡¶ï‡¶æ‡¶∂‡¶ø',82:'‡¶¨‡¶ø‡¶∞‡¶æ‡¶∂‡¶ø',83:'‡¶§‡¶ø‡¶∞‡¶æ‡¶∂‡¶ø',84:'‡¶ö‡ßÅ‡¶∞‡¶æ‡¶∂‡¶ø',85:'‡¶™‡¶Å‡¶ö‡¶æ‡¶∂‡¶ø',86:'‡¶õ‡¶ø‡¶Ø‡¶º‡¶æ‡¶∂‡¶ø',87:'‡¶∏‡¶æ‡¶§‡¶æ‡¶∂‡¶ø',88:'‡¶Ö‡¶∑‡ßç‡¶ü‡¶æ‡¶∂‡¶ø',89:'‡¶â‡¶®‡¶®‡¶¨‡ßç‡¶¨‡¶á'};
                const nineties = {91:'‡¶è‡¶ï‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',92:'‡¶¨‡¶ø‡¶∞‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',93:'‡¶§‡¶ø‡¶∞‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',94:'‡¶ö‡ßÅ‡¶∞‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',95:'‡¶™‡¶Å‡¶ö‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',96:'‡¶õ‡¶ø‡ßü‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',97:'‡¶∏‡¶æ‡¶§‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',98:'‡¶Ü‡¶ü‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á',99:'‡¶®‡¶ø‡¶∞‡¶æ‡¶®‡¶¨‡ßç‡¶¨‡¶á'};
                const maps2 = [twenties, thirties, forties, fifties, sixties, seventies, eighties, nineties];

                if (num < 10) return ones[num];
                if (num >= 10 && num < 20) return teens[num];
                if (num % 10 === 0 && num < 100) return tens[num] || toBnDigitsSpaced(num);
                if (num > 20 && num < 100) {
                    for (const m of maps2) if (m[num]) return m[num];
                    // Fallback composition (may be less natural): tens + ones
                    const t = Math.floor(num/10)*10; const r = num%10;
                    return `${tens[t] || toBnDigitsSpaced(t)} ${ones[r]}`;
                }

                // Hundreds
                if (num < 1000) {
                    const hundredsWord = ['','‡¶è‡¶ï‡¶∂','‡¶¶‡ßÅ‡¶á‡¶∂','‡¶§‡¶ø‡¶®‡¶∂','‡¶ö‡¶æ‡¶∞‡¶∂','‡¶™‡¶æ‡¶Å‡¶ö‡¶∂','‡¶õ‡¶Ø‡¶º‡¶∂','‡¶∏‡¶æ‡¶§‡¶∂','‡¶Ü‡¶ü‡¶∂','‡¶®‡¶Ø‡¶º‡¶∂'];
                    const h = Math.floor(num/100);
                    const r = num % 100;
                    const hWord = hundredsWord[h];
                    if (r === 0) return hWord;
                    const rWord = toBnWords(r);
                    return `${hWord} ${rWord}`;
                }

                // Thousands (simple): x ‡¶π‡¶æ‡¶ú‡¶æ‡¶∞ y
                if (num < 100000) {
                    const th = Math.floor(num/1000);
                    const r = num % 1000;
                    const thWord = th === 1 ? '‡¶è‡¶ï ‡¶π‡¶æ‡¶ú‡¶æ‡¶∞' : `${toBnWords(th)} ‡¶π‡¶æ‡¶ú‡¶æ‡¶∞`;
                    if (r === 0) return thWord;
                    return `${thWord} ${toBnWords(r)}`;
                }

                // Fallback for larger numbers
                return toBnDigitsSpaced(num);
            };

            // Calculates the sum of the first four columns for a given row.
            const calculateSumOfFirstFourColumns = (row) => {
                const firstFourNames = columnNames.slice(0, 4);
                return firstFourNames.reduce((sum, colName) => {
                    const value = parseFloat(row[colName]);
                    return sum + (isNaN(value) ? 0 : value);
                }, 0);
            };

            // Calculates the row total by subtracting the constant value.
            const calculateRowTotal = (row) => {
                const sumOfFirstFour = calculateSumOfFirstFourColumns(row);
                return sumOfFirstFour - subtractValue;
            };

            // --- Update Functions ---
            
            // Updates only the calculated sums and totals without re-rendering the whole table.
            const updateTableTotals = () => {
                // Helper: format numbers as integers (no decimals)
                const formatInt = (n) => {
                    const num = Number(n);
                    if (!isFinite(num)) return '0';
                    return Math.round(num).toString();
                };
                // Update Sums Row
                const columnSums = columnNames.reduce((acc, name) => {
                    acc[name] = calculateColumnSum(name);
                    return acc;
                }, {});

                const rankedColumnColors = {};
                if (Object.keys(columnSums).length > 0) {
                    const rankableSums = columnNames.slice(0, 4).map(name => ({
                        name: name,
                        sum: columnSums[name]
                    }));
                    rankableSums.sort((a, b) => b.sum - a.sum);

                    if (rankableSums[0]) rankedColumnColors[rankableSums[0].name] = 'text-green-600';
                    if (rankableSums[1]) rankedColumnColors[rankableSums[1].name] = 'text-blue-600';
                    if (rankableSums[2]) rankedColumnColors[rankableSums[2].name] = 'text-yellow-600';
                    if (rankableSums[3]) rankedColumnColors[rankableSums[3].name] = 'text-red-600';
                }

                columnNames.forEach((name, index) => {
                    const td = sumRowBody.children[index];
                    td.textContent = formatInt(columnSums[name]);
                    td.className = `px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-xl font-extrabold text-center ${rankedColumnColors[name] || ''}`;
                });

                // Update Data Rows Totals
                dataBody.querySelectorAll('tr').forEach((rowElement, rowIndex) => {
                    const row = rowData[rowIndex];
                    const rowTotal = calculateRowTotal(row);
                    const totalCell = rowElement.querySelector('.total-cell');
                    const totalTextColorClass = rowTotal > 0 ? 'text-red-600' : 'text-gray-700';
                    
                    if (totalCell) {
                        totalCell.textContent = formatInt(rowTotal);
                        totalCell.className = `px-1 py-1 sm:px-2 sm:py-2 whitespace-nowrap text-lg font-semibold text-center bg-blue-50 ${totalTextColorClass} total-cell`;
                    }
                });
            };

            // Renders the entire table from scratch. This is only called on initial load and for the clear action.
            const renderTable = () => {
                // Clear existing table content
                tableHeaderRow.innerHTML = '';
                sumRowBody.innerHTML = '';
                dataBody.innerHTML = '';

                // Render Header Row
                columnNames.forEach((name, index) => {
                    const th = document.createElement('th');
                    th.className = "table-cell-padding text-center text-sm md:text-base font-semibold uppercase tracking-wider";
                    th.scope = "col";
                    if(isLocked) {
                        th.innerHTML = `
                            <span data-col-index="${index}" title="${name}" class="cursor-pointer bg-transparent border-b border-white focus:outline-none text-center text-white placeholder-gray-300 w-12 sm:w-16 md:w-28 rounded-sm px-1 py-0.5 text-sm md:text-lg whitespace-nowrap overflow-hidden text-ellipsis truncate">${name}</span>
                        `;
                    } else {
                        th.innerHTML = `
                            <span data-col-index="${index}" title="${name}" class="cursor-pointer bg-transparent border-b border-white focus:outline-none text-center text-white placeholder-gray-300 w-12 sm:w-16 md:w-28 rounded-sm px-1 py-0.5 text-sm md:text-lg whitespace-nowrap overflow-hidden text-ellipsis truncate">${name}</span>
                        `;
                    }
                    tableHeaderRow.appendChild(th);
                });
                const totalTh = document.createElement('th');
                totalTh.className = "table-cell-padding text-center text-xs font-medium uppercase tracking-wider";
                totalTh.scope = "col";
                totalTh.textContent = "Total";
                tableHeaderRow.appendChild(totalTh);

                // Render Sums Row (placeholder for updateTableTotals)
                columnNames.forEach(() => {
                    const td = document.createElement('td');
                    td.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-xl font-extrabold text-center";
                    sumRowBody.appendChild(td);
                });
                const emptySumTd = document.createElement('td');
                emptySumTd.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-sm text-center bg-blue-200";
                sumRowBody.appendChild(emptySumTd);

                // Render Data Rows
                rowData.forEach((row, rowIndex) => {
                    const rowElement = document.createElement('tr');
                    const rowHasAnyValue = columnNames.some(name => {
                        const v = row[name];
                        return v !== null && v !== undefined && v.toString().trim() !== '';
                    });
                    const initialBg = rowHasAnyValue ? 'bg-yellow-50' : (rowIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white');
                    rowElement.className = `border-b ${initialBg} hover:bg-sky-50 transition-colors`;
                    
                    columnNames.forEach((colName, colIndex) => {
                        const cell = document.createElement('td');
                        cell.className = "px-1 py-1 sm:px-2 sm:py-2 whitespace-nowrap text-sm text-gray-900 text-center";
                        
                        cell.innerHTML = `
                            <input
                                type="number"
                                value="${row[colName]}"
                                data-row-index="${rowIndex}"
                                data-col-name="${colName}"
                                class="responsive-input w-12 sm:w-16 md:w-28 border rounded-lg px-1.5 py-1 text-center focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-colors ${row[colName] !== '' ? 'bg-gray-50 border-blue-300' : 'bg-white border-gray-300'}"
                            />
                        `;
                        rowElement.appendChild(cell);
                    });

                    // Render Total Cell
                    const totalCell = document.createElement('td');
                    const initialRowTotal = Math.round(calculateRowTotal(row));
                    const totalColorClass = initialRowTotal > 0
                        ? 'bg-rose-50 text-rose-600'
                        : (initialRowTotal < 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-100 text-gray-700');
                    totalCell.className = `px-2 py-1 sm:px-3 sm:py-1.5 whitespace-nowrap text-sm font-semibold text-center rounded-full ${totalColorClass} total-cell`;
                    totalCell.textContent = initialRowTotal.toString();
                    rowElement.appendChild(totalCell);

                    dataBody.appendChild(rowElement);
                });

                updateTableTotals();
            };
            
            // Render player list in the modal
            const renderPlayerList = () => {
                // Ensure list is sorted before rendering so indices align with the displayed order
                sortPlayers();
                playerListContainer.innerHTML = '';
                presetPlayers.forEach((player, index) => {
                    const playerItem = document.createElement('div');
                    playerItem.className = "flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 transition duration-150";
                    playerItem.innerHTML = `
                        <span class="text-lg font-semibold text-gray-800 flex-grow">${player}</span>
                        <div class="flex space-x-2">
                            <button class="edit-player-btn bg-yellow-400 text-white p-1 rounded-full hover:bg-yellow-500 transition duration-150" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <button class="delete-player-btn bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition duration-150" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                     <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    playerListContainer.appendChild(playerItem);
                });
            };
            
            // --- Event Handlers ---
            
            dataBody.addEventListener('input', (event) => {
                const target = event.target;
                if (target.tagName === 'INPUT' && target.type === 'number') {
                    const rowIndex = parseInt(target.dataset.rowIndex, 10);
                    const colName = target.dataset.colName;
                    const value = target.value;
                    
                    if (!isNaN(rowIndex) && colName) {
                        rowData[rowIndex][colName] = value;
                        saveData();
                        
                        // Dynamically update the Lachha text without re-rendering the whole table
                        const rowElement = dataBody.children[rowIndex];
                        const sumOfFirstFour = calculateSumOfFirstFourColumns(rowData[rowIndex]);
                        const shouldShowLachha = sumOfFirstFour === 360;
                        const lachhaColumns = ['‡¶Ü‡¶ï‡¶ø‡¶ú'];

                        lachhaColumns.forEach(lachhaColName => {
                            const lachhaColIndex = columnNames.indexOf(lachhaColName);
                            if (lachhaColIndex !== -1) {
                                const cell = rowElement.children[lachhaColIndex];
                                if (shouldShowLachha && (rowData[rowIndex][lachhaColName] === '' || rowData[rowIndex][lachhaColName] === '0')) {
                                    // Replace input with Lachha span
                                    if (cell.querySelector('input')) {
                                        cell.innerHTML = `<span class="block w-12 sm:w-16 md:w-28 bg-red-200 text-red-800 rounded-md px-1 py-0.5 text-center font-bold Lachha-text">
                                            üò´‡¶≤‡¶æ‡¶ö‡ßç‡¶õ‡¶æ
                                        </span>`;
                                    }
                                } else {
                                    // If Lachha text is visible and condition is not met, revert to input
                                    if (cell.querySelector('.Lachha-text')) {
                                        const valNow = rowData[rowIndex][lachhaColName] || '';
                                        const filledCls = valNow !== '' ? 'bg-gray-50 border-blue-300' : 'bg-white border-gray-300';
                                        cell.innerHTML = `<input type="number" value="${valNow}" data-row-index="${rowIndex}" data-col-name="${lachhaColName}" class="responsive-input w-12 sm:w-16 md:w-28 border rounded-md px-1 py-0.5 text-center focus:ring-blue-500 focus:border-blue-500 ${filledCls}" />`;
                                    }
                                }
                            }
                        });
                        
                        // Update sums and totals after all data and display logic is handled
                        updateTableTotals();

                        // Subtle style difference: filled vs empty inputs
                        const isFilled = (value !== null && value !== undefined && value.toString().trim() !== '');
                        target.classList.remove('bg-white', 'border-gray-300', 'bg-gray-50', 'border-blue-300');
                        if (isFilled) {
                            target.classList.add('bg-gray-50', 'border-blue-300');
                        } else {
                            target.classList.add('bg-white', 'border-gray-300');
                        }

                        // Row highlight: if any cell in this row has a value, highlight the whole row
                        const rowEl = dataBody.children[rowIndex];
                        const rowHasAny = columnNames.some(n => {
                            const v = (rowData[rowIndex][n] ?? '').toString().trim();
                            return v !== '';
                        });
                        rowEl.classList.remove('bg-white','bg-gray-50','bg-yellow-50');
                        rowEl.classList.add(rowHasAny ? 'bg-yellow-50' : (rowIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white'));
                    }
                }
            });
            
            clearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.remove('hidden');
            });

            confirmClearBtn.addEventListener('click', () => {
                rowData = initializeRowData();
                renderTable();
                clearConfirmModal.classList.add('hidden');
                localStorage.removeItem('calculatorData');
            });

            cancelClearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.add('hidden');
            });
            
            editToggleBtn.addEventListener('click', () => {
                isLocked = !isLocked;
                lockIcon.classList.toggle('hidden', !isLocked);
                editIcon.classList.toggle('hidden', isLocked);
                playerBtn.classList.toggle('hidden', isLocked); // This line now controls the player button
                renderTable();
                saveData();
            });

            playerBtn.addEventListener('click', () => {
                renderPlayerList();
                playerModal.classList.remove('hidden');
                document.getElementById('addPlayerInput').value = '';
                addPlayerBtn.textContent = '‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            });

            // Speak first 4 player names with their totals for Bangladesh (bn-BD)
            speakBtn.addEventListener('click', () => {
                try {
                    const firstFour = columnNames.slice(0, 4);
                    const items = firstFour.map(name => ({
                        name,
                        total: Math.round(calculateColumnSum(name))
                    }));

                    if ('speechSynthesis' in window) {
                        const synth = window.speechSynthesis;
                        synth.cancel();
                        // Prepare utterances: speak each name+number separately to avoid number skipping
                        const makeUtter = (text) => {
                            const u = new SpeechSynthesisUtterance(text);
                            u.lang = 'bn-BD';
                            u.rate = 0.85;
                            u.pitch = 1;
                            u.volume = 1;
                            return u;
                        };

                        // Try to use a Bengali voice if available
                        const pickBnVoice = () => {
                            const voices = synth.getVoices() || [];
                            // Priority: exact bn-BD, then any bn, then names containing Bangla/Bengali/Bangladesh
                            const bnBD = voices.find(v => (v.lang||'').toLowerCase() === 'bn-bd');
                            const bnAny = voices.find(v => (v.lang||'').toLowerCase().startsWith('bn'));
                            const byName = voices.find(v => /bangla|bengali|bangladesh/i.test(v.name || ''));
                            return bnBD || bnAny || byName || voices[0] || null;
                        };
                        // Some browsers load voices asynchronously; ensure we speak regardless
                        const voicesNow = synth.getVoices();
                        const queueSpeak = (voice) => {
                            // Build and enqueue each utterance
                            items.forEach(({ name, total }, idx) => {
                                const text = `${name}, ${toBnWords(total)}`;
                                const u = makeUtter(text);
                                if (voice) {
                                    u.voice = voice;
                                    if (voice.lang) u.lang = voice.lang;
                                }
                                // Stagger slightly to avoid clipping
                                setTimeout(() => synth.speak(u), idx * 150);
                            });
                        };
                        if (!voicesNow || voicesNow.length === 0) {
                            // Attempt delayed speak once voices load
                            const speakWithVoices = () => {
                                const v = pickBnVoice();
                                queueSpeak(v);
                            };
                            const onVoices = () => {
                                synth.onvoiceschanged = null;
                                speakWithVoices();
                            };
                            synth.onvoiceschanged = onVoices;
                            // Fallback timeout in case onvoiceschanged never fires
                            setTimeout(() => {
                                if (synth.speaking || synth.pending) return;
                                speakWithVoices();
                            }, 600);
                        } else {
                            const v = pickBnVoice();
                            queueSpeak(v);
                        }
                    } else {
                        // Fallback: simple alert if TTS not supported
                        const fallback = items.map(({name, total}) => `${name}: ${toBnDigits(total)}`).join('\n');
                        alert(fallback);
                    }
                } catch (e) {
                    console.error('Speak failed', e);
                }
            });

            cancelPlayerBtn.addEventListener('click', () => {
                playerModal.classList.add('hidden');
            });

            playerListContainer.addEventListener('click', (event) => {
                const target = event.target.closest('.edit-player-btn');
                if (target) {
                    const index = parseInt(target.dataset.index, 10);
                    const playerName = presetPlayers[index];
                    const playerItem = target.closest('.flex');
                    const nameSpan = playerItem.querySelector('span');

                    nameSpan.style.display = 'none';
                    playerItem.querySelector('.flex-grow').innerHTML = `
                        <input type="text" value="${playerName}" class="edit-player-input w-full px-2 py-1 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    playerItem.querySelector('.edit-player-input').focus();
                    target.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                    target.classList.remove('bg-yellow-400');
                    target.classList.add('bg-green-500');
                    target.classList.remove('edit-player-btn');
                    target.classList.add('save-player-btn');

                    const deleteBtn = playerItem.querySelector('.delete-player-btn');
                    deleteBtn.style.display = 'none';
                    return;
                }

                const deleteTarget = event.target.closest('.delete-player-btn');
                if (deleteTarget) {
                    const index = parseInt(deleteTarget.dataset.index, 10);
                    // Use a custom modal instead of alert
                    const modal = document.createElement('div');
                    modal.id = "deleteConfirmModal";
                    modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50";
                    modal.innerHTML = `
                      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4 text-gray-800">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
                        <div class="flex justify-center space-x-4">
                          <button id="confirmDeleteBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å</button>
                          <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md">‡¶®‡¶æ</button>
                        </div>
                      </div>
                    `;
                    document.body.appendChild(modal);

                    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                      presetPlayers.splice(index, 1);
                      saveData();
                      renderPlayerList();
                      modal.remove();
                    });

                    document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                      modal.remove();
                    });
                    return;
                }
                
                const saveTarget = event.target.closest('.save-player-btn');
                if (saveTarget) {
                    const index = parseInt(saveTarget.dataset.index, 10);
                    const newName = saveTarget.closest('.flex').querySelector('.edit-player-input').value.trim();
                    if (newName) {
                        presetPlayers[index] = newName;
                        saveData();
                        renderPlayerList();
                    }
                    return;
                }
            });

            addPlayerBtn.addEventListener('click', () => {
                const newName = addPlayerInput.value.trim();
                if (newName && !presetPlayers.includes(newName)) {
                    presetPlayers.push(newName);
                    sortPlayers();
                    addPlayerInput.value = '';
                    saveData();
                    renderPlayerList();
                } else if (newName) {
                    // Use a custom modal for alert
                    const modal = document.createElement('div');
                    modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50";
                    modal.innerHTML = `
                      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4 text-gray-800">‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá‡•§</p>
                        <button id="closeAlertBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
                      </div>
                    `;
                    document.body.appendChild(modal);
                    document.getElementById('closeAlertBtn').addEventListener('click', () => {
                      modal.remove();
                    });
                }
            });

            savePlayerListBtn.addEventListener('click', () => {
                // Sort before saving to keep persistent order
                sortPlayers();
                playerModal.classList.add('hidden');
                saveData(); // Save the updated list when the modal is closed
            });
            
            // ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßá, ‡¶è‡¶á ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡•§
            dynamicPlayerList.addEventListener('click', (event) => {
                const target = event.target.closest('div');
                if (target && target.dataset.name) {
                    const selectedName = target.dataset.name;
                    if (currentColumnIndex !== -1 && currentColumnIndex < columnNames.length) {
                        const oldName = columnNames[currentColumnIndex];
                        columnNames[currentColumnIndex] = selectedName;
                        
                        // rowData-‡¶è‡¶∞ ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
                        rowData.forEach(row => {
                            if (typeof row[oldName] !== 'undefined') {
                                row[selectedName] = row[oldName];
                                delete row[oldName];
                            }
                        });
                        
                        // Update the span element with the new name
                        const headerSpan = tableHeaderRow.querySelector(`span[data-col-index="${currentColumnIndex}"]`);
                        if(headerSpan) {
                            headerSpan.textContent = selectedName;
                        }

                        updateTableTotals();
                        saveData();
                    }
                    dynamicPlayerModal.classList.add('hidden');
                    currentColumnIndex = -1; // Reset index after selection
                }
            });
            
            cancelDynamicPlayerBtn.addEventListener('click', () => {
                dynamicPlayerModal.classList.add('hidden');
                currentColumnIndex = -1;
            });
            
            // ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ï‡¶ø‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶¨‡¶®‡ßç‡¶ß ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§
            // Now we listen for a click on the span instead of input focus.
            tableHeaderRow.addEventListener('click', (event) => {
                const target = event.target.closest('span');
                if (target && !isLocked) {
                    const colIndex = parseInt(target.dataset.colIndex, 10);
                    currentColumnIndex = colIndex;

                    dynamicPlayerList.innerHTML = '';
                    // Ensure sorted order in the dynamic list as well
                    sortPlayers();
                    presetPlayers.forEach(player => {
                        const playerItem = document.createElement('div');
                        playerItem.className = "cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition duration-150 text-lg font-semibold text-gray-800";
                        playerItem.textContent = player;
                        playerItem.dataset.name = player;
                        dynamicPlayerList.appendChild(playerItem);
                    });
                    dynamicPlayerModal.classList.remove('hidden');
                }
            });
            
            // Initial render
            loadData();
            lockIcon.classList.toggle('hidden', !isLocked);
            editIcon.classList.toggle('hidden', isLocked);
            playerBtn.classList.toggle('hidden', isLocked);
            renderTable();
        });
    </script>
</body>
</html>
