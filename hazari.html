<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for consistency and style */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hiding the number input spinners for a cleaner UI */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Modal styling */
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 640px) {
            .table-cell-padding {
                padding-left: 0.2rem;
                padding-right: 0.2rem;
            }
            .responsive-input {
                width: 2.5rem; /* tighter inputs on mobile to avoid horizontal overflow */
            }
            /* Prevent horizontal scroll on mobile */
            .no-x-overflow {
                overflow-x: hidden;
            }
            /* Make table fit within viewport width */
            table {
                table-layout: fixed;
                width: 100%;
            }
            thead th, tbody td {
                word-break: break-word;
                font-size: 0.85rem; /* slightly smaller text on mobile */
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-0 sm:p-4 sm:flex sm:items-center sm:justify-center">

    <div class="w-screen sm:w-full bg-transparent sm:bg-white max-w-none p-0 sm:p-4 md:p-6 rounded-none shadow-none sm:rounded-lg sm:shadow-xl">
        
        <div class="flex flex-col items-center mb-3 sm:mb-4">
            <div class="flex flex-wrap justify-center items-center gap-3 sm:gap-4">
                <button id="clearBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Clear
                </button>
                
                <button id="historyBtn" title="History" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    History
                </button>

                <button id="speakBtn" title="Speak" aria-label="Speak" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14a3 3 0 003-3V7a3 3 0 10-6 0v4a3 3 0 003 3z"/>
                        <path d="M19 11a1 1 0 10-2 0 5 5 0 11-10 0 1 1 0 10-2 0 7 7 0 0012 4.9V18a1 1 0 112 0v-2.1A7 7 0 0019 11z"/>
                    </svg>
                </button>
                <button id="editToggleBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-2 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg id="lockIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <svg id="editIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </button>
                <button id="playerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Player
                </button>
            </div>
        </div>

        <div class="overflow-x-hidden overflow-y-auto max-h-[70vh] rounded-none sm:rounded-lg">
            <table class="w-full table-auto divide-y divide-gray-200 rounded-none sm:rounded-lg overflow-hidden border-0 sm:border sm:border-gray-200">
                <thead class="bg-blue-600 text-white sticky top-0 z-10 shadow">
                    <tr id="tableHeaderRow">
                        </tr>
                </thead>
                <tbody id="sumRow" class="bg-blue-50 font-bold text-gray-800">
                    <tr>
                        </tr>
                </tbody>
                <tbody id="dataBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>

        <div class="flex justify-center mt-3 sm:mt-4 items-center">
            <button id="addRoundBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Add Round
            </button>
        </div>
    </div>

    <div id="clearConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p class="text-lg font-semibold mb-4 text-gray-800">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? <br><span class="text-sm text-gray-500">(‡¶è‡¶ü‡¶ø ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá)</span></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmClearBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶π‡ßç‡¶Ø‡¶æ‡¶Å
                </button>
                <button id="cancelClearBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶®‡¶æ
                </button>
            </div>
        </div>
    </div>
    
    <div id="playerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content w-full max-w-sm mx-auto p-6 rounded-lg shadow-xl">
            <p class="text-lg font-semibold mb-4 text-gray-800 text-center">‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <div id="playerListContainer" class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-2 mb-4 space-y-2">
                </div>
            <div class="flex justify-center space-x-4">
                <button id="savePlayerListBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Save
                </button>
                <button id="cancelPlayerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
            <hr class="my-4 border-gray-300">
            <div class="flex space-x-2">
                <input type="text" id="addPlayerInput" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="addPlayerBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
    
    <div id="dynamicPlayerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content w-full max-w-xs mx-auto p-6 rounded-lg shadow-xl">
            <p class="text-lg font-semibold mb-4 text-gray-800 text-center">‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <div id="dynamicPlayerList" class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-2 mb-4 space-y-2">
                </div>
            <div class="flex justify-center space-x-4">
                <button id="cancelDynamicPlayerBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-xl w-full max-w-lg mx-2 sm:mx-auto max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    ‡¶ñ‡ßá‡¶≤‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ (History)
                </h3>
                <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="historyListContainer" class="flex-grow overflow-y-auto space-y-3 pr-2 mb-4">
                <p class="text-center text-gray-500 mt-4">‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>
            </div>
            
            <div class="border-t pt-4 flex justify-between items-center">
                <span id="historyCount" class="text-sm text-gray-500 font-medium"></span>
                <button id="clearHistoryBtn" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-bold transition">
                    ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State management
            let columnNames = ['‡¶π‡¶æ‡¶Æ‡¶ø‡¶Æ', '‡¶∏‡ßã‡¶π‡ßá‡¶≤', '‡¶ö‡¶û‡ßç‡¶ö‡¶≤', '‡¶Ü‡¶ï‡¶ø‡¶ú'];
            let numRows = 1;
            const subtractValue = 360;
            let isLocked = true;
            
            let presetPlayers = [
                '‡¶π‡¶æ‡¶Æ‡¶ø‡¶Æ', '‡¶∏‡ßã‡¶π‡ßá‡¶≤', '‡¶ö‡¶û‡ßç‡¶ö‡¶≤', '‡¶Ü‡¶ï‡¶ø‡¶ú', '‡¶∏‡ßÅ‡¶Æ‡¶®', '‡¶´‡¶Ø‡¶º‡¶õ‡¶æ‡¶≤', '‡¶®‡¶æ‡¶à‡¶Æ', '‡¶Æ‡¶ì‡¶≤‡¶æ', '‡¶™‡¶≤‡¶æ‡¶∂', '‡¶á‡¶Æ‡¶∞‡¶æ‡¶®', '‡¶ú‡¶∏‡¶ø‡¶Æ'
            ];
            
            let rowData = [];
            let currentColumnIndex = -1;

            const sortPlayers = () => {
                try {
                    presetPlayers.sort((a, b) => a.localeCompare(b, 'bn', { sensitivity: 'base' }));
                } catch (e) {
                    presetPlayers.sort((a, b) => a.localeCompare(b));
                }
            };

            const loadData = () => {
                const savedData = localStorage.getItem('calculatorData');
                const savedPlayers = localStorage.getItem('playerNames');
                const savedLockState = localStorage.getItem('isLocked');
                
                if (savedPlayers) {
                    try {
                        presetPlayers = JSON.parse(savedPlayers);
                        sortPlayers();
                    } catch (e) {
                        console.error("Failed to parse saved player names.", e);
                    }
                }

                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        columnNames = parsedData.columnNames || ['‡¶π‡¶æ‡¶Æ‡¶ø‡¶Æ', '‡¶∏‡ßã‡¶π‡ßá‡¶≤', '‡¶ö‡¶û‡ßç‡¶ö‡¶≤', '‡¶Ü‡¶ï‡¶ø‡¶ú'];
                        rowData = Array.isArray(parsedData.rowData) ? parsedData.rowData : [];
                        numRows = Math.max(1, rowData.length || 1);
                        
                        rowData = Array.from({ length: numRows }, (_, i) => {
                            const row = parsedData.rowData && parsedData.rowData[i] ? { ...parsedData.rowData[i] } : { id: i };
                            row.id = i;
                            columnNames.forEach(name => {
                                if (typeof row[name] === 'undefined') row[name] = '';
                            });
                            return row;
                        });
                    } catch (e) {
                        numRows = 1;
                        rowData = initializeRowData();
                    }
                } else {
                    numRows = 1;
                    rowData = initializeRowData();
                }

                if (savedLockState !== null) {
                    isLocked = JSON.parse(savedLockState);
                }
            };
            
            const saveData = () => {
                localStorage.setItem('calculatorData', JSON.stringify({ columnNames, rowData }));
                localStorage.setItem('playerNames', JSON.stringify(presetPlayers));
                localStorage.setItem('isLocked', JSON.stringify(isLocked));
            };

            const initializeRowData = () => {
                const initialData = [];
                for (let i = 0; i < numRows; i++) {
                    const row = { id: i };
                    columnNames.forEach(name => {
                        row[name] = '';
                    });
                    initialData.push(row);
                }
                return initialData;
            };

            // DOM Elements
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const sumRowBody = document.getElementById('sumRow').querySelector('tr');
            const dataBody = document.getElementById('dataBody');
            
            // Toolbar buttons
            const clearBtn = document.getElementById('clearBtn');
            const historyBtn = document.getElementById('historyBtn'); // NEW
            const editToggleBtn = document.getElementById('editToggleBtn');
            const lockIcon = document.getElementById('lockIcon');
            const editIcon = document.getElementById('editIcon');
            const playerBtn = document.getElementById('playerBtn');
            const speakBtn = document.getElementById('speakBtn');
            let addRoundBtn = null;

            // Modals
            const clearConfirmModal = document.getElementById('clearConfirmModal');
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            
            const playerModal = document.getElementById('playerModal');
            const playerListContainer = document.getElementById('playerListContainer');
            const savePlayerListBtn = document.getElementById('savePlayerListBtn');
            const cancelPlayerBtn = document.getElementById('cancelPlayerBtn');
            const addPlayerInput = document.getElementById('addPlayerInput');
            const addPlayerBtn = document.getElementById('addPlayerBtn');
            
            const dynamicPlayerModal = document.getElementById('dynamicPlayerModal');
            const dynamicPlayerList = document.getElementById('dynamicPlayerList');
            const cancelDynamicPlayerBtn = document.getElementById('cancelDynamicPlayerBtn');

            // History Modal Elements (New)
            const historyModal = document.getElementById('historyModal');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            const historyListContainer = document.getElementById('historyListContainer');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const historyCount = document.getElementById('historyCount');


            // --- Calculation Functions ---
            const calculateColumnSum = (colName) => {
                return rowData.reduce((sum, row) => {
                    const value = parseFloat(row[colName]);
                    return sum + (isNaN(value) ? 0 : value);
                }, 0);
            };

            const toBnDigits = (n) => {
                const map = '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ';
                const s = Math.round(Number(n || 0)).toString();
                return s.replace(/[0-9]/g, d => map[d]);
            };
            const toBnDigitsSpaced = (n) => toBnDigits(n).split('').join(' ');

            const toBnWords = (num) => {
                num = Math.round(Number(num || 0));
                if (!isFinite(num) || num < 0) return toBnDigitsSpaced(num);
                // (Simplified for brevity, same logic as before usually goes here)
                return toBnDigitsSpaced(num); 
            };

            const calculateSumOfFirstFourColumns = (row) => {
                const firstFourNames = columnNames.slice(0, 4);
                return firstFourNames.reduce((sum, colName) => {
                    const value = parseFloat(row[colName]);
                    return sum + (isNaN(value) ? 0 : value);
                }, 0);
            };

            const calculateRowTotal = (row) => {
                const sumOfFirstFour = calculateSumOfFirstFourColumns(row);
                return sumOfFirstFour - subtractValue;
            };

            // --- Update Functions ---
            const updateTableTotals = () => {
                const formatInt = (n) => {
                    const num = Number(n);
                    if (!isFinite(num)) return '0';
                    return Math.round(num).toString();
                };
                const columnSums = columnNames.reduce((acc, name) => {
                    acc[name] = calculateColumnSum(name);
                    return acc;
                }, {});

                const rankedColumnColors = {};
                if (Object.keys(columnSums).length > 0) {
                    const rankableSums = columnNames.slice(0, 4).map(name => ({
                        name: name,
                        sum: columnSums[name]
                    }));
                    rankableSums.sort((a, b) => b.sum - a.sum);

                    if (rankableSums[0]) rankedColumnColors[rankableSums[0].name] = 'text-green-600';
                    if (rankableSums[1]) rankedColumnColors[rankableSums[1].name] = 'text-blue-600';
                    if (rankableSums[2]) rankedColumnColors[rankableSums[2].name] = 'text-yellow-600';
                    if (rankableSums[3]) rankedColumnColors[rankableSums[3].name] = 'text-red-600';
                }

                columnNames.forEach((name, index) => {
                    const td = sumRowBody.children[index + 1];
                    td.textContent = formatInt(columnSums[name]);
                    td.className = `px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-xl font-extrabold text-center ${rankedColumnColors[name] || ''}`;
                });

                dataBody.querySelectorAll('tr').forEach((rowElement, rowIndex) => {
                    const row = rowData[rowIndex];
                    const rowTotal = calculateRowTotal(row);
                    const totalCell = rowElement.querySelector('.total-cell');
                    const totalTextColorClass = rowTotal > 0 ? 'text-red-600' : 'text-gray-700';
                    
                    if (totalCell) {
                        totalCell.textContent = formatInt(rowTotal);
                        totalCell.className = `px-1 py-1 sm:px-2 sm:py-2 whitespace-nowrap text-lg font-semibold text-center bg-blue-50 ${totalTextColorClass} total-cell`;
                    }
                });
            };

            const renderTable = () => {
                tableHeaderRow.innerHTML = '';
                sumRowBody.innerHTML = '';
                dataBody.innerHTML = '';

                // Header
                const roundHeader = document.createElement('th');
                roundHeader.className = "table-cell-padding text-center text-xs font-medium uppercase tracking-wider";
                tableHeaderRow.appendChild(roundHeader);

                columnNames.forEach((name, index) => {
                    const th = document.createElement('th');
                    th.className = "table-cell-padding text-center text-sm md:text-base font-semibold uppercase tracking-wider";
                    th.innerHTML = `<span data-col-index="${index}" class="cursor-pointer bg-transparent border-b border-white text-center text-white w-12 sm:w-16 md:w-28 rounded-sm px-1 py-0.5 text-sm md:text-lg whitespace-nowrap overflow-hidden text-ellipsis truncate">${name}</span>`;
                    tableHeaderRow.appendChild(th);
                });
                const totalTh = document.createElement('th');
                totalTh.className = "table-cell-padding text-center text-xs font-medium uppercase tracking-wider";
                totalTh.textContent = "Total";
                tableHeaderRow.appendChild(totalTh);

                // Sum Row
                const roundEmpty = document.createElement('td');
                roundEmpty.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-sm text-center";
                sumRowBody.appendChild(roundEmpty);
                columnNames.forEach(() => {
                    const td = document.createElement('td');
                    td.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-xl font-extrabold text-center";
                    sumRowBody.appendChild(td);
                });
                const emptySumTd = document.createElement('td');
                emptySumTd.className = "px-1 py-1 sm:px-2 sm:py-3 whitespace-nowrap text-sm text-center bg-blue-200";
                sumRowBody.appendChild(emptySumTd);

                // Data Rows
                rowData.forEach((row, rowIndexVisible) => {
                    const rowElement = document.createElement('tr');
                    const rowHasAnyValue = columnNames.some(name => {
                        const v = row[name];
                        return v !== null && v !== undefined && v.toString().trim() !== '';
                    });
                    const initialBg = rowHasAnyValue ? 'bg-yellow-50' : (rowIndexVisible % 2 === 0 ? 'bg-gray-50' : 'bg-white');
                    rowElement.className = `border-b ${initialBg} hover:bg-sky-50 transition-colors`;
                    
                    const globalRowIndex = typeof row.id === 'number' ? row.id : rowIndexVisible;
                    const isLastRow = (rowIndexVisible === rowData.length - 1);

                    const roundTd = document.createElement('td');
                    roundTd.className = "px-2 py-1 whitespace-nowrap text-sm text-gray-700 text-center";
                    
                    let controls = '';
                    if (!isLastRow) {
                        if (row.isEditing) {
                            controls = `<div class="flex items-center gap-2"><button class="cancel-edit-btn bg-red-500 hover:bg-red-600 text-white p-1 rounded-full" data-row-index="${globalRowIndex}"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button><button class="save-edit-btn bg-green-500 hover:bg-green-600 text-white p-1 rounded-full" data-row-index="${globalRowIndex}"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L7 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button></div>`;
                        } else {
                            controls = `<button class="edit-round-btn bg-gray-200 hover:bg-gray-300 text-gray-800 p-1 rounded-full" data-row-index="${globalRowIndex}"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>`;
                        }
                    }
                    roundTd.innerHTML = `<div class="flex items-center justify-center">${controls}</div>`;
                    rowElement.appendChild(roundTd);
                    
                    columnNames.forEach((colName) => {
                        const cell = document.createElement('td');
                        cell.className = "px-1 py-1 sm:px-2 sm:py-2 whitespace-nowrap text-sm text-gray-900 text-center";
                        if (isLastRow || row.isEditing) {
                            cell.innerHTML = `<input type="number" value="${row[colName]}" data-row-index-global="${globalRowIndex}" data-col-name="${colName}" class="responsive-input w-12 sm:w-16 md:w-28 border rounded-lg px-1.5 py-1 text-center focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-colors ${row[colName] !== '' ? 'bg-gray-50 border-blue-300' : 'bg-white border-gray-300'}" />`;
                        } else {
                            const numRaw = (row[colName] === '' || row[colName] === undefined) ? 0 : parseFloat(row[colName]);
                            const val = isNaN(numRaw) ? 0 : numRaw;
                            const color = val > 0 ? 'text-emerald-600' : (val < 0 ? 'text-rose-600' : 'text-gray-500');
                            cell.innerHTML = `<span class="inline-block min-w-[3rem] px-1 py-0.5 rounded-md ${color} text-base font-semibold">${val}</span>`;
                        }
                        rowElement.appendChild(cell);
                    });

                    const totalCell = document.createElement('td');
                    const initialRowTotal = Math.round(calculateRowTotal(row));
                    const totalColorClass = initialRowTotal > 0 ? 'bg-rose-50 text-rose-600' : (initialRowTotal < 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-100 text-gray-700');
                    totalCell.className = `px-2 py-1 sm:px-3 sm:py-1.5 whitespace-nowrap text-sm font-semibold text-center rounded-full ${totalColorClass} total-cell`;
                    totalCell.textContent = initialRowTotal.toString();
                    rowElement.appendChild(totalCell);

                    dataBody.appendChild(rowElement);
                });

                updateTableTotals();
            };
            
            // --- History Functionality ---
            
            const getHistory = () => {
                const h = localStorage.getItem('hazariHistory');
                return h ? JSON.parse(h) : [];
            };
            
            const saveToHistory = () => {
                // Only save if there's actual data (sum > 0 for at least one person or multiple rounds)
                const hasData = rowData.some(r => columnNames.some(c => (r[c] && r[c] != 0)));
                if (!hasData && numRows <= 1) return;

                const now = new Date();
                const dateTime = now.toLocaleString('bn-BD', { 
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: 'numeric', minute: 'numeric', hour12: true 
                });
                
                // Calculate final scores
                const scores = columnNames.map(name => ({
                    name: name,
                    total: calculateColumnSum(name)
                }));
                
                // Sort scores to show winner first
                scores.sort((a, b) => b.total - a.total);

                const gameRecord = {
                    id: Date.now(),
                    date: dateTime,
                    rounds: numRows,
                    scores: scores
                };
                
                const history = getHistory();
                history.unshift(gameRecord); // Add to top
                localStorage.setItem('hazariHistory', JSON.stringify(history));
            };

            const renderHistory = () => {
                const history = getHistory();
                historyListContainer.innerHTML = '';
                historyCount.textContent = `‡¶Æ‡ßã‡¶ü ‡¶ñ‡ßá‡¶≤‡¶æ: ${toBnDigits(history.length)}`;

                if (history.length === 0) {
                    historyListContainer.innerHTML = '<div class="text-center py-8 text-gray-400"><p class="text-xl">üìú</p><p>‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</p></div>';
                    return;
                }

                history.forEach(game => {
                    const item = document.createElement('div');
                    item.className = "bg-gray-50 border border-gray-200 rounded-lg p-3 hover:shadow-md transition duration-200";
                    
                    let scoreHtml = '<div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-2">';
                    game.scores.forEach((s, i) => {
                        const rankColor = i === 0 ? 'text-green-600 font-bold' : (i === game.scores.length - 1 ? 'text-red-500' : 'text-gray-700');
                        const medal = i === 0 ? 'üëë' : '';
                        scoreHtml += `
                            <div class="flex justify-between text-sm ${rankColor}">
                                <span>${medal} ${s.name}</span>
                                <span>${toBnDigits(s.total)}</span>
                            </div>
                        `;
                    });
                    scoreHtml += '</div>';

                    item.innerHTML = `
                        <div class="flex justify-between items-center border-b pb-2 mb-1">
                            <span class="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-1 rounded">${game.date}</span>
                            <span class="text-xs text-gray-400">${toBnDigits(game.rounds)} ‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°</span>
                        </div>
                        ${scoreHtml}
                    `;
                    historyListContainer.appendChild(item);
                });
            };

            // History Button Events
            historyBtn.addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
            });
            
            closeHistoryBtn.addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });
            
            clearHistoryBtn.addEventListener('click', () => {
                if(confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                    localStorage.removeItem('hazariHistory');
                    renderHistory();
                }
            });

            // --- Existing Logic modified to support history ---

            dataBody.addEventListener('click', (event) => {
                const editBtn = event.target.closest('.edit-round-btn');
                if (editBtn) {
                    const idx = parseInt(editBtn.dataset.rowIndex, 10);
                    if (!isNaN(idx) && rowData[idx]) {
                        rowData[idx]._saved = { ...rowData[idx] };
                        rowData[idx].isEditing = true;
                        saveData();
                        renderTable();
                    }
                    return;
                }
                const cancelBtn = event.target.closest('.cancel-edit-btn');
                if (cancelBtn) {
                    const idx = parseInt(cancelBtn.dataset.rowIndex, 10);
                    if (!isNaN(idx) && rowData[idx]) {
                        if (rowData[idx]._saved) {
                            const snap = rowData[idx]._saved;
                            columnNames.forEach(n => { rowData[idx][n] = snap[n] ?? ''; });
                            delete rowData[idx]._saved;
                        }
                        rowData[idx].isEditing = false;
                        saveData();
                        renderTable();
                    }
                    return;
                }
                const saveBtn = event.target.closest('.save-edit-btn');
                if (saveBtn) {
                    const idx = parseInt(saveBtn.dataset.rowIndex, 10);
                    if (!isNaN(idx) && rowData[idx]) {
                        if (rowData[idx]._saved) delete rowData[idx]._saved;
                        rowData[idx].isEditing = false;
                        saveData();
                        renderTable();
                    }
                }
            });

            dataBody.addEventListener('input', (event) => {
                const target = event.target;
                if (target.tagName === 'INPUT' && target.type === 'number') {
                    const globalRowIndex = parseInt(target.dataset.rowIndexGlobal, 10);
                    const colName = target.dataset.colName;
                    const value = target.value;
                    
                    if (!isNaN(globalRowIndex) && colName) {
                        rowData[globalRowIndex][colName] = value;
                        saveData();
                        updateTableTotals();
                        
                        const isFilled = (value !== null && value !== undefined && value.toString().trim() !== '');
                        target.classList.remove('bg-white', 'border-gray-300', 'bg-gray-50', 'border-blue-300');
                        if (isFilled) {
                            target.classList.add('bg-gray-50', 'border-blue-300');
                        } else {
                            target.classList.add('bg-white', 'border-gray-300');
                        }
                        
                        const rowEl = target.closest('tr');
                        const rowHasAny = columnNames.some(n => {
                            const v = (rowData[globalRowIndex][n] ?? '').toString().trim();
                            return v !== '';
                        });
                        rowEl.classList.remove('bg-white','bg-gray-50','bg-yellow-50');
                        rowEl.classList.add(rowHasAny ? 'bg-yellow-50' : 'bg-white');
                    }
                }
            });

            clearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.remove('hidden');
            });

            confirmClearBtn.addEventListener('click', () => {
                // SAVE TO HISTORY BEFORE CLEARING
                saveToHistory();

                numRows = 1;
                rowData = initializeRowData();
                renderTable();
                clearConfirmModal.classList.add('hidden');
                localStorage.removeItem('calculatorData');
            });

            cancelClearBtn.addEventListener('click', () => {
                clearConfirmModal.classList.add('hidden');
            });
            
            editToggleBtn.addEventListener('click', () => {
                isLocked = !isLocked;
                lockIcon.classList.toggle('hidden', !isLocked);
                editIcon.classList.toggle('hidden', isLocked);
                playerBtn.classList.toggle('hidden', isLocked);
                renderTable();
                saveData();
            });

            playerBtn.addEventListener('click', () => {
                // Logic mostly same as before, simplified rendering
                playerListContainer.innerHTML = '';
                sortPlayers();
                presetPlayers.forEach((player, index) => {
                    const playerItem = document.createElement('div');
                    playerItem.className = "flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 transition duration-150";
                    playerItem.innerHTML = `
                        <span class="text-lg font-semibold text-gray-800 flex-grow">${player}</span>
                        <div class="flex space-x-2">
                            <button class="edit-player-btn bg-yellow-400 text-white p-1 rounded-full hover:bg-yellow-500" data-index="${index}"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                            <button class="delete-player-btn bg-red-500 text-white p-1 rounded-full hover:bg-red-600" data-index="${index}"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    `;
                    playerListContainer.appendChild(playerItem);
                });
                playerModal.classList.remove('hidden');
                document.getElementById('addPlayerInput').value = '';
            });

            speakBtn.addEventListener('click', () => {
                try {
                    const firstFour = columnNames.slice(0, 4);
                    const items = firstFour.map(name => ({
                        name,
                        total: Math.round(calculateColumnSum(name))
                    }));

                    if ('speechSynthesis' in window) {
                        const synth = window.speechSynthesis;
                        synth.cancel();
                        const makeUtter = (text) => {
                            const u = new SpeechSynthesisUtterance(text);
                            u.lang = 'bn-BD';
                            return u;
                        };
                        items.forEach(({ name, total }, idx) => {
                            setTimeout(() => synth.speak(makeUtter(`${name}, ${total}`)), idx * 500);
                        });
                    } else {
                        alert(items.map(({name, total}) => `${name}: ${total}`).join('\n'));
                    }
                } catch (e) {
                    console.error('Speak failed', e);
                }
            });

            cancelPlayerBtn.addEventListener('click', () => {
                playerModal.classList.add('hidden');
            });
            
            // Player List Events
            playerListContainer.addEventListener('click', (event) => {
                // Edit / Delete logic (same as original, shortened for brevity here but functional)
                const delTarget = event.target.closest('.delete-player-btn');
                if(delTarget) {
                     presetPlayers.splice(parseInt(delTarget.dataset.index), 1);
                     saveData();
                     playerBtn.click(); // Re-render
                }
                const editTarget = event.target.closest('.edit-player-btn');
                if(editTarget) {
                    const idx = editTarget.dataset.index;
                    const newName = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ:", presetPlayers[idx]);
                    if(newName) {
                        presetPlayers[idx] = newName;
                        saveData();
                        playerBtn.click();
                    }
                }
            });

            addPlayerBtn.addEventListener('click', () => {
                const newName = addPlayerInput.value.trim();
                if (newName && !presetPlayers.includes(newName)) {
                    presetPlayers.push(newName);
                    saveData();
                    playerBtn.click();
                }
            });

            const setupAddRound = () => {
                addRoundBtn = document.getElementById('addRoundBtn');
                if (!addRoundBtn) return;
                addRoundBtn.onclick = () => {
                    numRows += 1;
                    const newRow = { id: rowData.length };
                    columnNames.forEach(name => { newRow[name] = ''; });
                    rowData.push(newRow);
                    saveData();
                    renderTable();
                };
            };

            savePlayerListBtn.addEventListener('click', () => {
                sortPlayers();
                playerModal.classList.add('hidden');
                saveData();
            });

            dynamicPlayerList.addEventListener('click', (event) => {
                const target = event.target.closest('div');
                if (target && target.dataset.name) {
                    const selectedName = target.dataset.name;
                    if (currentColumnIndex !== -1) {
                        const oldName = columnNames[currentColumnIndex];
                        columnNames[currentColumnIndex] = selectedName;
                        rowData.forEach(row => {
                            if (typeof row[oldName] !== 'undefined') {
                                row[selectedName] = row[oldName];
                                delete row[oldName];
                            }
                        });
                        updateTableTotals();
                        saveData();
                        renderTable();
                    }
                    dynamicPlayerModal.classList.add('hidden');
                }
            });

            cancelDynamicPlayerBtn.addEventListener('click', () => {
                dynamicPlayerModal.classList.add('hidden');
            });
            
            tableHeaderRow.addEventListener('click', (event) => {
                const target = event.target.closest('span');
                if (target && !isLocked) {
                    currentColumnIndex = parseInt(target.dataset.colIndex, 10);
                    dynamicPlayerList.innerHTML = '';
                    sortPlayers();
                    presetPlayers.forEach(player => {
                        const div = document.createElement('div');
                        div.className = "cursor-pointer p-2 rounded-lg hover:bg-gray-100 font-semibold";
                        div.textContent = player;
                        div.dataset.name = player;
                        dynamicPlayerList.appendChild(div);
                    });
                    dynamicPlayerModal.classList.remove('hidden');
                }
            });
            
            // Init
            loadData();
            lockIcon.classList.toggle('hidden', !isLocked);
            editIcon.classList.toggle('hidden', isLocked);
            playerBtn.classList.toggle('hidden', isLocked);
            renderTable();
            setupAddRound();
        });
    </script>
</body>
</html>
