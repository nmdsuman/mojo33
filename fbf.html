<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .invoice-box table {
      width: 100%;
      border-collapse: collapse;
    }
    .invoice-box table tr.heading td {
      background: #2563eb; /* blue-600 */
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 8px;
    }
    .invoice-box table tr.item td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px;
    }
    .invoice-box table tr.item:nth-child(even) td {
      background: #f9fafb;
    }
    .invoice-box table tr.total td {
      font-weight: bold;
      padding: 6px;
    }
    .invoice-footer {
      margin-top: 2rem;
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
    }
    .icon-small {
      width: 1rem;
      height: 1rem;
      display: inline-block;
      fill: currentColor;
    }
    @media print {
      .no-print { display: none; }
      body { background: white; }
      .invoice-container {
        display: block !important;
        margin: 0;
      }
      #input-panel {
        display: none;
      }
      .invoice-box {
        box-shadow: none;
      }
    }
    .tab-button {
        padding: 10px 15px;
        background-color: #e5e7eb;
        color: #4b5563;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .tab-button.active {
        background-color: #2563eb;
        color: white;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .input-group {
        position: relative;
    }
    .paste-button {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: #e5e7eb;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .paste-button:hover {
        background: #d1d5db;
    }
    /* Modal styles */
    .modal {
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        position: relative;
    }
    .close-button {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .invoice-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
    .invoice-list-item:last-child {
        border-bottom: none;
    }
  </style>
</head>
<body class="bg-gray-50 p-6">

  <!-- Main container for the split view -->
  <div class="invoice-container grid grid-cols-1 lg:grid-cols-2 gap-8 w-full max-w-7xl mx-auto">
    <!-- Left Panel: Input Forms -->
    <div id="input-panel" class="no-print bg-white rounded-xl shadow-2xl p-6 md:p-10">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</h1>
      
      <!-- Tab Buttons -->
      <div class="flex space-x-2 mb-4">
          <button id="tab-client" class="tab-button active">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</button>
          <button id="tab-items" class="tab-button">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</button>
          <button id="tab-settings" class="tab-button">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
      </div>
      
      <!-- Tab Contents -->
      <div id="tab-content-container">
        <!-- Client Info Tab -->
        <div id="content-client" class="tab-content active mb-8 border-b pb-8">
            <h3 class="font-semibold text-lg text-gray-800 mb-4">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>
            <div class="input-group mb-2">
                <input type="text" id="client-name-input" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('client-name-input')">
                    üìã
                </button>
            </div>
            <div class="input-group mb-2">
                <input type="text" id="client-mobile-input" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('client-mobile-input')">
                    üìã
                </button>
            </div>
            <div class="input-group">
                <input type="text" id="client-address-input" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('client-address-input')">
                    üìã
                </button>
            </div>
            <div class="input-group mt-2">
                <input type="text" id="statfast-code-input" placeholder="‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ï‡ßã‡¶°" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('statfast-code-input')">
                    üìã
                </button>
            </div>
        </div>
        
        <!-- Items Tab -->
        <div id="content-items" class="tab-content mb-6">
            <h3 class="font-semibold text-lg text-gray-800 mb-4">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 font-semibold text-gray-700">
                <div class="md:col-span-2">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</div>
                <div>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div>
                <div>‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)</div>
                <div>‡¶Æ‡ßã‡¶ü</div>
            </div>
            <div id="input-items-container">
                <!-- Item rows will be added dynamically -->
            </div>
            <button id="add-item" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                + ‡¶Ü‡¶∞‡¶ì ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
            <div class="flex flex-col md:flex-row justify-end mt-8">
              <div class="w-full md:w-1/2 lg:w-1/3 space-y-2">
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú:</span>
                  <input type="number" id="delivery-charge-input" value="0" min="0" class="w-24 text-right border rounded-md px-2 py-1">
                </div>
                <div class="flex justify-between items-center text-gray-700">
                  <span class="font-medium">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°:</span>
                  <select id="payment-method-input" class="w-24 border rounded-md px-2 py-1 bg-white">
                    <option value="‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø (COD)">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø (COD)</option>
                    <option value="‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ (bKash)">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ (bKash)</option>
                  </select>
                </div>
              </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="content-settings" class="tab-content mb-8 border-b pb-8">
            <h3 class="font-semibold text-lg text-gray-800 mb-4">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>
            <div class="input-group mb-2">
                <input type="text" id="company-name-input" placeholder="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" value="‡¶´‡ßÅ‡¶°‡¶ø ‡¶π‡¶æ‡¶ü" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('company-name-input')">
                    üìã
                </button>
            </div>
            <div class="input-group mb-2">
                <input type="text" id="company-address-input" placeholder="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" value="‡¶π‡¶æ‡¶§‡¶ø‡¶Ø‡¶º‡¶æ‡¶°‡¶º‡¶æ, ‡¶ï‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('company-address-input')">
                    üìã
                </button>
            </div>
            <div class="input-group">
                <input type="text" id="company-mobile-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" value="01796548423" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button class="paste-button" onclick="pasteFromClipboard('company-mobile-input')">
                    üìã
                </button>
            </div>

            <!-- Footer Info Input moved here -->
            <div class="mt-8 border-t pt-8">
              <h3 class="font-semibold text-lg text-gray-800 mb-2">‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞‡ßá ‡¶§‡¶•‡ßç‡¶Ø</h3>
              <div class="input-group mb-2">
                  <textarea id="footer-message-input" placeholder="‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ" rows="2" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚ù§Ô∏è</textarea>
                  <button class="paste-button" onclick="pasteFromClipboard('footer-message-input')">
                      üìã
                  </button>
              </div>
              
              <div class="flex items-center gap-2 mb-2">
                <select id="social-media-select" class="w-2/5 md:w-1/3 border rounded-md px-2 py-1 bg-white">
                  <option value="website">‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü</option>
                  <option value="facebook">‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï</option>
                </select>
                <div class="input-group w-full">
                    <input type="text" id="social-media-link-input" placeholder="‡¶≤‡¶ø‡¶Ç‡¶ï/‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ" value="www.apnarshop.com" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <button class="paste-button" onclick="pasteFromClipboard('social-media-link-input')">
                        üìã
                    </button>
                </div>
              </div>
              
              <div class="input-group">
                  <input type="text" id="footer-phone-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" value="01796548423" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                  <button class="paste-button" onclick="pasteFromClipboard('footer-phone-input')">
                        üìã
                  </button>
              </div>
            </div>
        </div>
      </div>
      
      <!-- Save and Print Buttons -->
      <div class="no-print mt-6 text-center">
        <button id="show-saved-invoices-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2">
          üìÅ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
        </button>
        <button id="save-invoice-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2 mt-2">
          ‚úÖ ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2 mt-2">
          üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
      </div>
      <div id="message-box" class="mt-4 p-4 rounded-lg text-center" style="display: none;"></div>
    </div>

    <!-- Right Panel: Live Preview -->
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg invoice-box">
      <!-- Header -->
      <div class="flex justify-between items-center border-b pb-4 mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-800" id="company-name-display">üõçÔ∏è ‡¶´‡ßÅ‡¶°‡¶ø ‡¶π‡¶æ‡¶ü</h1>
          <p class="text-gray-600 text-sm"><span class="font-bold">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</span> <span id="company-address-display">‡¶π‡¶æ‡¶§‡¶ø‡¶Ø‡¶º‡¶æ‡¶°‡¶º‡¶æ, ‡¶ï‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú</span></p>
          <p class="text-gray-600 text-sm"><span class="font-bold">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</span> <span id="company-mobile-display">01796548423</span></p>
        </div>
        <div class="text-right">
          <p class="text-sm"><span class="font-bold">‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶®‡¶Ç:</span> <span id="invoice-number-display">INV-10001</span></p>
          <p class="text-sm"><span class="font-bold">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</span> <span id="invoice-date-display">08 ‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞ 2025</span></p>
        </div>
      </div>

      <!-- Customer Info -->
      <div class="mb-6">
        <h2 class="font-semibold text-gray-700 mb-2">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h2>
        <p><span class="font-bold">‡¶®‡¶æ‡¶Æ:</span> <span id="client-name-display">‡¶ú‡¶®‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶π‡¶æ‡¶§ ‡¶π‡ßã‡¶∏‡ßá‡¶®</span></p>
        <p><span class="font-bold">‡¶´‡ßã‡¶®:</span> <span id="client-mobile-display">017XXXXXXXX</span></p>
        <p><span class="font-bold">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</span> <span id="client-address-display">‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂</span></p>
        <p><span class="font-bold">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ï‡ßã‡¶°:</span> <span id="statfast-code-display"></span></p>
      </div>

      <!-- Items Table -->
      <table class="w-full mb-6">
        <tr class="heading">
          <td>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</td>
          <td>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</td>
          <td>‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)</td>
          <td>‡¶Æ‡ßã‡¶ü (‡ß≥)</td>
        </tr>
        <tbody id="invoice-items-display">
          <!-- Items will be populated dynamically -->
        </tbody>
        <tr class="total">
          <td colspan="3" class="text-right">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü:</td>
          <td id="sub-total">0</td>
        </tr>
        <tr class="total">
          <td colspan="3" class="text-right">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú:</td>
          <td id="delivery-charge-display">0</td>
        </tr>
        <tr class="total">
          <td colspan="3" class="text-right text-blue-600">‡¶Æ‡ßã‡¶ü:</td>
          <td class="text-blue-600" id="grand-total">0</td>
        </tr>
      </table>

      <!-- Footer -->
      <div class="invoice-footer">
        <span id="footer-message-display">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚ù§Ô∏è</span> <br>
        <div class="flex justify-center items-center mt-2">
          <span id="social-media-icon-display" class="inline-block mr-2"></span>
          <span id="social-media-link-display" class="text-blue-600"></span>
          <span id="footer-phone-display" class="ml-4"></span>
        </div>
        <br>
        <p id="payment-method-display"><span class="font-bold">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°:</span> ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø (COD)</p>
      </div>
    </div>
  </div>

  <!-- Modal for Saved Invoices -->
  <div id="saved-invoices-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-modal-button">&times;</span>
      <h2 class="text-2xl font-bold mb-4">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏</h2>
      <div id="invoice-list-container" class="max-h-96 overflow-y-auto">
        <!-- Invoices will be populated here -->
      </div>
      <p id="empty-list-message" class="text-gray-500 mt-4" style="display: none;">‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§</p>
      <div id="loading-message" class="text-blue-500 mt-4 text-center" style="display: none;">‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, collection, getDocs, doc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug'); // Enable Firestore logging

    // Canvas environment variables (DO NOT MODIFY)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = {
      apiKey: "AIzaSyACr4tymiTKrtPltKbAlLulsdG3efoDowQ",
      authDomain: "facebook-c7ea6.firebaseapp.com",
      projectId: "facebook-c7ea6",
      storageBucket: "facebook-c7ea6.firebasestorage.app",
      messagingSenderId: "28858429763",
      appId: "1:28858429763:web:6ddbe43ea94a4bfaf4bff6",
      measurementId: "G-M3VEVHMDH1"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId;
    let firebaseInitialized = false;

    // A function to show messages to the user
    const showMessage = (msg, className) => {
        messageBox.textContent = msg;
        messageBox.className = `${className} mt-4 p-4 rounded-lg text-center`;
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 3000);
    };

    // Firebase initialization
    const initializeFirebase = async () => {
        try {
            if (app) {
                return;
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            firebaseInitialized = true;

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            console.log("Firebase initialized successfully. User ID:", userId);
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            showMessage("Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡•§", 'bg-red-200 text-red-800');
            firebaseInitialized = false;
        }
    };

    // Handles pasting text from the clipboard to a target input field using a fallback method.
    function pasteFromClipboard(targetId) {
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            // Focus the element to make it ready for paste operation
            targetElement.focus();
            try {
                // Use the older document.execCommand('paste') as a fallback
                document.execCommand('paste');
            } catch (err) {
                console.error('Failed to execute paste command: ', err);
            }
        }
    }
    window.pasteFromClipboard = pasteFromClipboard;

    document.addEventListener('DOMContentLoaded', () => {
      // Input elements
      const companyNameInput = document.getElementById('company-name-input');
      const companyAddressInput = document.getElementById('company-address-input');
      const companyMobileInput = document.getElementById('company-mobile-input');
      const clientNameInput = document.getElementById('client-name-input');
      const clientMobileInput = document.getElementById('client-mobile-input');
      const clientAddressInput = document.getElementById('client-address-input');
      const statfastCodeInput = document.getElementById('statfast-code-input');
      const inputItemsContainer = document.getElementById('input-items-container');
      const addItemButton = document.getElementById('add-item');
      const deliveryChargeInput = document.getElementById('delivery-charge-input');
      const paymentMethodInput = document.getElementById('payment-method-input');
      const footerMessageInput = document.getElementById('footer-message-input');
      const socialMediaSelect = document.getElementById('social-media-select');
      const socialMediaLinkInput = document.getElementById('social-media-link-input');
      const footerPhoneInput = document.getElementById('footer-phone-input');
      const saveInvoiceButton = document.getElementById('save-invoice-button');
      const showSavedInvoicesButton = document.getElementById('show-saved-invoices-button');
      const messageBox = document.getElementById('message-box');
      const savedInvoicesModal = document.getElementById('saved-invoices-modal');
      const closeModalButton = document.getElementById('close-modal-button');
      const invoiceListContainer = document.getElementById('invoice-list-container');
      const emptyListMessage = document.getElementById('empty-list-message');
      const loadingMessage = document.getElementById('loading-message');


      // Display elements
      const companyNameDisplay = document.getElementById('company-name-display');
      const companyAddressDisplay = document.getElementById('company-address-display');
      const companyMobileDisplay = document.getElementById('company-mobile-display');
      const clientNameDisplay = document.getElementById('client-name-display');
      const clientMobileDisplay = document.getElementById('client-mobile-display');
      const clientAddressDisplay = document.getElementById('client-address-display');
      const statfastCodeDisplay = document.getElementById('statfast-code-display');
      const invoiceItemsDisplay = document.getElementById('invoice-items-display');
      const subTotalDisplay = document.getElementById('sub-total');
      const grandTotalDisplay = document.getElementById('grand-total');
      const deliveryChargeDisplay = document.getElementById('delivery-charge-display');
      const invoiceNumberDisplay = document.getElementById('invoice-number-display');
      const invoiceDateDisplay = document.getElementById('invoice-date-display');
      const paymentMethodDisplay = document.getElementById('payment-method-display');
      const footerMessageDisplay = document.getElementById('footer-message-display');
      const socialMediaIconDisplay = document.getElementById('social-media-icon-display');
      const socialMediaLinkDisplay = document.getElementById('social-media-link-display');
      const footerPhoneDisplay = document.getElementById('footer-phone-display');

      // Tab buttons and contents
      const tabClientBtn = document.getElementById('tab-client');
      const tabItemsBtn = document.getElementById('tab-items');
      const tabSettingsBtn = document.getElementById('tab-settings');
      const contentClient = document.getElementById('content-client');
      const contentItems = document.getElementById('content-items');
      const contentSettings = document.getElementById('content-settings');

      // Function to generate a random invoice number
      const generateInvoiceNumber = () => {
        return `INV-${Math.floor(10000 + Math.random() * 90000)}`;
      };

      // Function to get current date in Bengali
      const getFormattedDate = () => {
        const date = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return date.toLocaleDateString('bn-BD', options);
      };

      // Social media SVG icons
      const icons = {
        website: `<svg class="icon-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-1-14v2.09c.358-.063.722-.09 1.09-.09 1.942 0 3.518 1.407 3.924 3.238L16 11.238V9h-2v3.086c-.34-.131-.692-.224-1.056-.282L12 12H9v-2h2v-2zM9 13v2h2v-2H9zm4 0v2h2v-2h-2zM12 7v2h2V7h-2zm-3 4v2h2v-2H9z"/></svg>`,
        facebook: `<svg class="icon-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm3.176 8.52h-2.164v8.138h-3.172v-8.138H8.761V7.99h1.999V6.372c0-2.28 1.408-3.484 3.587-3.484h2.245v2.793h-1.666c-.662 0-.82.235-.82.812v1.5H16.143L15.65 10.52z"/></svg>`
      };

      // Set initial invoice details
      invoiceNumberDisplay.textContent = generateInvoiceNumber();
      invoiceDateDisplay.textContent = getFormattedDate();

      // Function to get data from all input fields
      const collectData = () => {
        const items = [];
        document.querySelectorAll('#input-items-container .grid').forEach(row => {
          const itemNameInput = row.querySelector('.item-name-input');
          const itemQuantityInput = row.querySelector('.item-quantity-input');
          const itemPriceInput = row.querySelector('.item-price-input');

          items.push({
            name: itemNameInput.value,
            quantity: parseFloat(itemQuantityInput.value) || 0,
            price: parseFloat(itemPriceInput.value) || 0,
          });
        });

        return {
          company: {
            name: companyNameInput.value,
            address: companyAddressInput.value,
            mobile: companyMobileInput.value,
          },
          client: {
            name: clientNameInput.value,
            mobile: clientMobileInput.value,
            address: clientAddressInput.value,
            statfastCode: statfastCodeInput.value,
          },
          items: items,
          deliveryCharge: parseFloat(deliveryChargeInput.value) || 0,
          paymentMethod: paymentMethodInput.value,
          footer: {
            message: footerMessageInput.value,
            socialMedia: socialMediaSelect.value,
            socialMediaLink: socialMediaLinkInput.value,
            phone: footerPhoneInput.value,
          },
          invoiceNumber: invoiceNumberDisplay.textContent,
          invoiceDate: invoiceDateDisplay.textContent,
          timestamp: new Date().toISOString()
        };
      };

      // Function to save data to Firestore
      const saveInvoice = async () => {
          if (!firebaseInitialized || !db) {
              showMessage("Firebase ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'bg-red-200 text-red-800');
              return;
          }

          const invoiceData = collectData();
          try {
              const invoicesCollection = collection(db, `invoices`);
              await addDoc(invoicesCollection, invoiceData);
              showMessage("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", 'bg-green-200 text-green-800');
          } catch (e) {
              console.error("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ", e);
              showMessage("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", 'bg-red-200 text-red-800');
          }
      };
      
      // Function to add a new item row
      const addItemRow = (item = {}) => {
        const newItemRow = document.createElement('div');
        newItemRow.className = 'grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-4';
        newItemRow.innerHTML = `
          <div class="input-group md:col-span-2">
              <input type="text" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" value="${item.name || ''}" class="item-name-input w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
              <button class="paste-button" onclick="pasteFromClipboard(this.previousElementSibling.id)">
                  üìã
              </button>
          </div>
          <div class="input-group">
              <input type="number" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" value="${item.quantity || 1}" min="1" class="item-quantity-input w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 text-right">
              <button class="paste-button" onclick="pasteFromClipboard(this.previousElementSibling.id)">
                  üìã
              </button>
          </div>
          <div class="input-group">
              <input type="number" placeholder="‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" value="${item.price || 0}" min="0" class="item-price-input w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 text-right">
              <button class="paste-button" onclick="pasteFromClipboard(this.previousElementSibling.id)">
                  üìã
              </button>
          </div>
          <p class="text-right text-sm">‡ß≥ 0</p>
        `;
        // To ensure unique IDs for dynamically created inputs
        const uniqueId = `item-name-${Date.now()}`;
        newItemRow.querySelector('.item-name-input').id = uniqueId;
        const uniqueId2 = `item-quantity-${Date.now()}`;
        newItemRow.querySelector('.item-quantity-input').id = uniqueId2;
        const uniqueId3 = `item-price-${Date.now()}`;
        newItemRow.querySelector('.item-price-input').id = uniqueId3;
        
        inputItemsContainer.appendChild(newItemRow);
        updateInvoicePreview();
      };

      // Function to load a saved invoice into the form
      const loadInvoiceData = (invoiceData) => {
        // Populate client info
        clientNameInput.value = invoiceData.client.name || '';
        clientMobileInput.value = invoiceData.client.mobile || '';
        clientAddressInput.value = invoiceData.client.address || '';
        statfastCodeInput.value = invoiceData.client.statfastCode || '';
        companyNameInput.value = invoiceData.company.name || '';
        companyAddressInput.value = invoiceData.company.address || '';
        companyMobileInput.value = invoiceData.company.mobile || '';
        footerMessageInput.value = invoiceData.footer.message || '';
        socialMediaSelect.value = invoiceData.footer.socialMedia || 'website';
        socialMediaLinkInput.value = invoiceData.footer.socialMediaLink || '';
        footerPhoneInput.value = invoiceData.footer.phone || '';
        deliveryChargeInput.value = invoiceData.deliveryCharge || 0;
        paymentMethodInput.value = invoiceData.paymentMethod || '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø (COD)';

        // Populate items
        inputItemsContainer.innerHTML = '';
        if (invoiceData.items && invoiceData.items.length > 0) {
            invoiceData.items.forEach(item => {
                addItemRow(item);
            });
        } else {
            addItemRow();
        }

        // Close the modal and show a message
        savedInvoicesModal.style.display = 'none';
        showMessage("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", 'bg-blue-200 text-blue-800');
        updateInvoicePreview();
        activateTab('client');
      };
      
      // Function to delete an invoice from Firestore
      const deleteInvoice = async (docId) => {
        if (!firebaseInitialized || !db) {
              showMessage("Firebase ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'bg-red-200 text-red-800');
              return;
        }
        try {
          await deleteDoc(doc(db, "invoices", docId));
          showMessage("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", 'bg-green-200 text-green-800');
          // Refresh the list after deletion
          loadSavedInvoices();
        } catch (e) {
          console.error("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Æ‡ßã‡¶õ‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ", e);
          showMessage("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Æ‡ßã‡¶õ‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", 'bg-red-200 text-red-800');
        }
      };

      // Function to render the list of saved invoices in the modal
      const renderSavedInvoicesList = (invoices) => {
        invoiceListContainer.innerHTML = '';
        emptyListMessage.style.display = 'none';
        
        if (invoices.length === 0) {
            emptyListMessage.style.display = 'block';
            return;
        }

        invoices.forEach(invoice => {
          const listItem = document.createElement('div');
          listItem.className = 'invoice-list-item';
          listItem.innerHTML = `
            <div class="flex flex-col">
              <p class="font-bold text-gray-800">${invoice.client.name}</p>
              <p class="text-sm text-gray-500">‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶®‡¶Ç: ${invoice.invoiceNumber}</p>
              <p class="text-sm text-gray-500">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${invoice.invoiceDate}</p>
            </div>
            <div class="space-x-2 flex">
              <button class="bg-blue-500 text-white text-xs px-3 py-1 rounded-full hover:bg-blue-600 load-invoice-btn" data-doc-id="${invoice.id}">‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
              <button class="bg-red-500 text-white text-xs px-3 py-1 rounded-full hover:bg-red-600 delete-invoice-btn" data-doc-id="${invoice.id}">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>
          `;
          invoiceListContainer.appendChild(listItem);
        });

        // Attach event listeners to the new buttons
        invoiceListContainer.querySelectorAll('.load-invoice-btn').forEach(btn => {
            const invoice = invoices.find(inv => inv.id === btn.dataset.docId);
            btn.addEventListener('click', () => loadInvoiceData(invoice));
        });

        invoiceListContainer.querySelectorAll('.delete-invoice-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteInvoice(btn.dataset.docId));
        });
      };

      // Function to load all saved invoices from Firestore
      const loadSavedInvoices = async () => {
          if (!firebaseInitialized || !db) {
              showMessage("Firebase ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'bg-red-200 text-red-800');
              return;
          }
          savedInvoicesModal.style.display = 'flex';
          loadingMessage.style.display = 'block';
          invoiceListContainer.innerHTML = '';
          emptyListMessage.style.display = 'none';

          try {
              const querySnapshot = await getDocs(collection(db, "invoices"));
              const invoices = [];
              querySnapshot.forEach((doc) => {
                  invoices.push({ id: doc.id, ...doc.data() });
              });
              // Sort invoices by timestamp to show the latest first
              invoices.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
              renderSavedInvoicesList(invoices);
          } catch (e) {
              console.error("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ", e);
              showMessage("‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", 'bg-red-200 text-red-800');
          } finally {
              loadingMessage.style.display = 'none';
          }
      };

      // Function to load data (now from a default state)
      const loadData = () => {
        companyNameInput.value = '‡¶´‡ßÅ‡¶°‡¶ø ‡¶π‡¶æ‡¶ü';
        companyAddressInput.value = '‡¶π‡¶æ‡¶§‡¶ø‡¶Ø‡¶º‡¶æ‡¶°‡¶º‡¶æ, ‡¶ï‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú';
        companyMobileInput.value = '01796548423';
        footerMessageInput.value = '‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚ù§Ô∏è';
        socialMediaLinkInput.value = 'www.apnarshop.com';
        footerPhoneInput.value = '01796548423';
        addItemRow();
        activateTab('client');
      };

      // Function to update the entire invoice preview
      const updateInvoicePreview = () => {
        // Update company and client info
        companyNameDisplay.textContent = companyNameInput.value || '‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ';
        companyAddressDisplay.textContent = companyAddressInput.value || '‡¶¢‡¶æ‡¶ï‡¶æ, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂';
        companyMobileDisplay.textContent = companyMobileInput.value || '018XXXXXXXX';
        
        clientNameDisplay.textContent = clientNameInput.value || '‡¶ú‡¶®‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶π‡¶æ‡¶§ ‡¶π‡ßã‡¶∏‡ßá‡¶®';
        clientMobileDisplay.textContent = clientMobileInput.value || '017XXXXXXXX';
        clientAddressDisplay.textContent = clientAddressInput.value || '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂';
        statfastCodeDisplay.textContent = statfastCodeInput.value || '';

        // Update items table
        invoiceItemsDisplay.innerHTML = '';
        let subTotal = 0;
        
        const itemRows = document.querySelectorAll('#input-items-container .grid');
        itemRows.forEach((row) => {
          const itemNameInput = row.querySelector('.item-name-input');
          const itemQuantityInput = row.querySelector('.item-quantity-input');
          const itemPriceInput = row.querySelector('.item-price-input');
          
          const itemName = itemNameInput.value;
          const quantity = parseFloat(itemQuantityInput.value) || 0;
          const price = parseFloat(itemPriceInput.value) || 0;
          const itemTotal = quantity * price;
          
          row.querySelector('p').textContent = `‡ß≥ ${itemTotal.toFixed(2)}`;

          subTotal += itemTotal;

          const displayRow = document.createElement('tr');
          displayRow.className = 'item';
          displayRow.innerHTML = `
            <td>${itemName || '‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ'}</td>
            <td class="text-center">${quantity}</td>
            <td class="text-center">${price.toFixed(2)}</td>
            <td class="text-center">${itemTotal.toFixed(2)}</td>
          `;
          invoiceItemsDisplay.appendChild(displayRow);
        });

        // Update totals
        const deliveryCharge = parseFloat(deliveryChargeInput.value) || 0;
        const grandTotal = subTotal + deliveryCharge;

        subTotalDisplay.textContent = subTotal.toFixed(2);
        deliveryChargeDisplay.textContent = deliveryCharge.toFixed(2);
        grandTotalDisplay.textContent = grandTotal.toFixed(2);

        // Update payment method display
        paymentMethodDisplay.innerHTML = `<span class="font-bold">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°:</span> ${paymentMethodInput.value}`;

        // Update footer display
        footerMessageDisplay.textContent = footerMessageInput.value || '‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚ù§Ô∏è';
        footerPhoneDisplay.textContent = `üìû ${footerPhoneInput.value || '01796548423'}`;
        
        // Update social media icon and link
        const selectedIcon = socialMediaSelect.value;
        const socialLink = socialMediaLinkInput.value;
        socialMediaIconDisplay.innerHTML = icons[selectedIcon] || '';
        socialMediaLinkDisplay.innerHTML = `<a href="http://${socialLink}" target="_blank" class="text-blue-600">${socialLink}</a>`;
      };

      // Function to handle tab switching
      const activateTab = (tabId) => {
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

          document.getElementById(`tab-${tabId}`).classList.add('active');
          document.getElementById(`content-${tabId}`).classList.add('active');
      };

      // Event listeners for tab buttons
      tabClientBtn.addEventListener('click', () => activateTab('client'));
      tabItemsBtn.addEventListener('click', () => activateTab('items'));
      tabSettingsBtn.addEventListener('click', () => activateTab('settings'));
      
      // Event listeners for saving and updating
      document.getElementById('input-panel').addEventListener('input', updateInvoicePreview);
      
      // Add new item row
      addItemButton.addEventListener('click', addItemRow);

      // Save invoice to Firestore
      saveInvoiceButton.addEventListener('click', saveInvoice);

      // Show and load saved invoices
      showSavedInvoicesButton.addEventListener('click', loadSavedInvoices);
      closeModalButton.addEventListener('click', () => {
        savedInvoicesModal.style.display = 'none';
      });

      // Initial load of data when the page loads
      loadData();
    });

    // Initialize Firebase on page load
    initializeFirebase();
  </script>
</body>
</html>
